<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chore Quest - Earn Gems & Battle! üíé‚öîÔ∏è</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Cinzel:wght@600;700;900&family=Crimson+Pro:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --ocean-deep: #0a1f3d;
            --ocean-mid: #1a3a5c;
            --ocean-light: #2e5a7d;
            --wave-foam: #4a7c9e;
            --wood-dark: #3d2817;
            --wood-mid: #6b4423;
            --gold: #d4af37;
            --gold-light: #f4d03f;
            --blood-red: #8b1e1e;
            --fire-orange: #ff6b35;
            --legendary-purple: #9333ea;
            --rare-blue: #3b82f6;
            --common-gray: #6b7280;
            --health-green: #51cf66;
            --gold-dark: #b8960c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Fredoka', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .chore-view { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .battle-view {
            font-family: 'Crimson Pro', serif;
            background: linear-gradient(180deg, var(--ocean-deep) 0%, var(--ocean-mid) 50%, var(--ocean-light) 100%);
        }
        .collection-view { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); }
        
        .bounce { animation: bounce 0.5s ease; }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        
        .float { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        
        .shine { position: relative; overflow: hidden; }
        .shine::after {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shine 3s infinite;
        }
        @keyframes shine { 0% { transform: translateX(-100%) translateY(-100%); } 100% { transform: translateX(100%) translateY(100%); } }

        .legendary-glow { animation: legendary-glow 2s ease-in-out infinite; }
        @keyframes legendary-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(147, 51, 234, 0.5), 0 0 40px rgba(147, 51, 234, 0.3); }
            50% { box-shadow: 0 0 30px rgba(147, 51, 234, 0.8), 0 0 60px rgba(147, 51, 234, 0.5); }
        }

        .rare-glow { animation: rare-glow 2s ease-in-out infinite; }
        @keyframes rare-glow {
            0%, 100% { box-shadow: 0 0 15px rgba(59, 130, 246, 0.4), 0 0 30px rgba(59, 130, 246, 0.2); }
            50% { box-shadow: 0 0 25px rgba(59, 130, 246, 0.6), 0 0 45px rgba(59, 130, 246, 0.4); }
        }

        .loot-card { perspective: 1000px; }
        .loot-card-inner { transition: transform 0.8s; transform-style: preserve-3d; }
        .loot-card.flipped .loot-card-inner { transform: rotateY(180deg); }
        .loot-card-front, .loot-card-back { backface-visibility: hidden; position: absolute; width: 100%; height: 100%; }
        .loot-card-back { transform: rotateY(180deg); }

        .confetti-piece {
            position: fixed;
            width: 10px; height: 10px;
            animation: confetti-fall 3s ease-out forwards;
            pointer-events: none;
            z-index: 1000;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .screen-shake { animation: screen-shake 0.5s ease-in-out; }
        @keyframes screen-shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-10px); }
            40%, 80% { transform: translateX(10px); }
        }

        .ocean-waves { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; overflow: hidden; }
        .wave { position: absolute; width: 200%; height: 100px; background: linear-gradient(90deg, transparent, rgba(74, 124, 158, 0.1), transparent); animation: wave-drift 20s infinite linear; }
        .wave:nth-child(1) { top: 20%; animation-duration: 15s; opacity: 0.3; }
        .wave:nth-child(2) { top: 40%; animation-duration: 20s; animation-delay: -5s; opacity: 0.2; }
        .wave:nth-child(3) { top: 60%; animation-duration: 25s; animation-delay: -10s; opacity: 0.15; }
        @keyframes wave-drift { 0% { transform: translateX(-50%); } 100% { transform: translateX(0%); } }

        .ship { position: relative; width: 100%; max-width: 400px; height: 280px; display: flex; align-items: center; justify-content: center; transition: transform 0.3s ease; }
        .ship.attacking { animation: ship-attack 0.6s ease; }
        .ship.damaged { animation: ship-damage 0.5s ease; }
        @keyframes ship-attack { 0%, 100% { transform: translateX(0); } 30% { transform: translateX(-15px) rotate(-3deg); } 60% { transform: translateX(15px) rotate(3deg); } }
        @keyframes ship-damage { 0%, 100% { transform: translateX(0) rotate(0deg); } 25% { transform: translateX(-10px) rotate(-5deg); } 50% { transform: translateX(10px) rotate(5deg); } 75% { transform: translateX(-10px) rotate(-5deg); } }

        .ship-visual { width: 100%; height: 100%; filter: drop-shadow(0 8px 20px rgba(0, 0, 0, 0.8)); transition: all 0.5s ease; }
        .player-ship .ship-visual { transform: scaleX(-1); }
        .ship-visual.size-tiny { transform: scale(0.6); }
        .ship-visual.size-small { transform: scale(0.7); }
        .ship-visual.size-medium { transform: scale(0.9); }
        .ship-visual.size-large { transform: scale(1.0); }
        .ship-visual.size-huge { transform: scale(1.1); }
        .ship-visual.size-massive { transform: scale(1.2); }
        .ship-visual.size-legendary { transform: scale(1.3); animation: legendary-pulse 3s ease-in-out infinite; }
        @keyframes legendary-pulse {
            0%, 100% { filter: drop-shadow(0 8px 20px rgba(0,0,0,0.8)) drop-shadow(0 0 40px rgba(212,175,55,0.4)); }
            50% { filter: drop-shadow(0 8px 20px rgba(0,0,0,0.8)) drop-shadow(0 0 60px rgba(212,175,55,0.6)); }
        }
        .player-ship .ship-visual.size-tiny { transform: scale(0.6) scaleX(-1); }
        .player-ship .ship-visual.size-small { transform: scale(0.7) scaleX(-1); }
        .player-ship .ship-visual.size-medium { transform: scale(0.9) scaleX(-1); }
        .player-ship .ship-visual.size-large { transform: scale(1.0) scaleX(-1); }
        .player-ship .ship-visual.size-huge { transform: scale(1.1) scaleX(-1); }
        .player-ship .ship-visual.size-massive { transform: scale(1.2) scaleX(-1); }
        .player-ship .ship-visual.size-legendary { transform: scale(1.3) scaleX(-1); }

        .sail { animation: sail-wave 3s ease-in-out infinite; transform-origin: top; }
        @keyframes sail-wave { 0%, 100% { transform: skewX(0deg); } 50% { transform: skewX(2deg); } }

        .flag { animation: flag-flutter 2s ease-in-out infinite; transform-origin: left; }
        @keyframes flag-flutter { 0%, 100% { transform: rotate(0deg) scaleX(1); } 25% { transform: rotate(-3deg) scaleX(0.95); } 75% { transform: rotate(3deg) scaleX(1.05); } }

        .health-bar { width: 100%; height: 30px; background: rgba(0,0,0,0.5); border-radius: 15px; overflow: hidden; border: 2px solid var(--gold); position: relative; }
        .health-fill { height: 100%; background: linear-gradient(90deg, var(--blood-red), #c92a2a, var(--blood-red)); transition: width 0.5s ease; position: relative; overflow: hidden; }
        .health-fill::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: health-shine 2s infinite; }
        @keyframes health-shine { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .health-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: 700; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); font-size: 1rem; }

        .damage-number { position: fixed; font-family: 'Cinzel', serif; font-size: 3rem; font-weight: 900; color: var(--fire-orange); text-shadow: 2px 2px 4px rgba(0,0,0,0.8), 0 0 10px var(--fire-orange); pointer-events: none; animation: damage-float 1s ease-out forwards; z-index: 100; }
        @keyframes damage-float { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-80px) scale(1.3); } }

        .combat-log { background: rgba(10, 31, 61, 0.6); border: 2px solid rgba(74, 124, 158, 0.5); border-radius: 15px; padding: 20px; margin: 20px 0; max-height: 200px; overflow-y: auto; backdrop-filter: blur(5px); }
        .log-entry { padding: 8px 0; border-bottom: 1px solid rgba(74, 124, 158, 0.2); font-size: 1.1rem; animation: log-entry-appear 0.3s ease; }
        .log-entry:last-child { border-bottom: none; }
        @keyframes log-entry-appear { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .log-damage { color: var(--fire-orange); font-weight: 600; }
        .log-heal { color: #51cf66; font-weight: 600; }
        .combat-log::-webkit-scrollbar { width: 10px; }
        .combat-log::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); border-radius: 5px; }
        .combat-log::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 5px; }

        .progress-bar-container { width: 100%; height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--gold), var(--gold-light)); transition: width 0.3s ease; }

        .boss-entrance { animation: boss-entrance 1s ease-out; }
        @keyframes boss-entrance { 0% { transform: scale(0) rotate(-180deg); opacity: 0; } 50% { transform: scale(1.2) rotate(10deg); } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }

        .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
        @keyframes pulse-glow { 0%, 100% { filter: drop-shadow(0 0 10px currentColor); } 50% { filter: drop-shadow(0 0 25px currentColor); } }

        .streak-fire { animation: streak-fire 0.5s ease-in-out infinite alternate; }
        @keyframes streak-fire { from { transform: scale(1) rotate(-5deg); } to { transform: scale(1.1) rotate(5deg); } }

        .unlock-burst { animation: unlock-burst 0.6s ease-out forwards; }
        @keyframes unlock-burst { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.3); } 100% { transform: scale(1); opacity: 1; } }

        /* Sound toggle button */
        .sound-toggle { position: fixed; top: 10px; right: 10px; z-index: 1000; background: rgba(0,0,0,0.5); border: 2px solid white; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.5rem; transition: all 0.3s; }
        .sound-toggle:hover { transform: scale(1.1); background: rgba(0,0,0,0.7); }
        .sound-toggle.muted { opacity: 0.5; }

        /* Real-time Battle Styles */
        .battle-action-btn {
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 30px;
            border: none;
            border-radius: 15px;
            font-weight: 700;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 100px;
        }

        .battle-action-btn.fire {
            flex: 2;
            background: linear-gradient(135deg, #c0392b, #e74c3c);
            color: white;
            border: 3px solid #f39c12;
        }

        .battle-action-btn.repair {
            flex: 1;
            background: linear-gradient(135deg, #2980b9, #3498db);
            color: white;
            border: 3px solid #5dade2;
        }

        .battle-action-btn:disabled {
            opacity: 0.6;
            filter: grayscale(50%);
            cursor: not-allowed;
        }

        .battle-action-btn:not(:disabled):active {
            transform: scale(0.95);
        }

        .battle-action-btn.ready {
            animation: btn-ready-pulse 1s infinite;
        }

        @keyframes btn-ready-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(244, 208, 63, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(244, 208, 63, 0); }
        }

        .cooldown-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.6);
            transition: height 0.1s linear;
        }

        .btn-label {
            position: relative;
            z-index: 1;
        }

        .cooldown-text {
            font-size: 0.9rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        /* Cooldown Indicators */
        .cooldown-indicators {
            display: flex;
            gap: 20px;
            justify-content: center;
            font-size: 0.85rem;
            color: #8899a6;
            margin: 10px 0;
        }

        .cooldown-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .cooldown-indicator .bar {
            width: 50px;
            height: 8px;
            background: rgba(0,0,0,0.5);
            border-radius: 4px;
            overflow: hidden;
        }

        .cooldown-indicator .bar-fill {
            height: 100%;
            background: var(--fire-orange);
            transition: width 0.1s linear;
        }

        .cooldown-indicator.repair .bar-fill {
            background: #3498db;
        }

        /* Auto Battle Toggle */
        .auto-battle-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px;
        }

        .auto-battle-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.4);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .auto-battle-toggle:hover {
            background: rgba(0,0,0,0.5);
        }

        .toggle-switch {
            width: 50px;
            height: 26px;
            background: rgba(255,255,255,0.2);
            border-radius: 13px;
            position: relative;
            transition: background 0.3s ease;
        }

        .toggle-switch.active {
            background: #27ae60;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle-switch.active::after {
            transform: translateX(24px);
        }

        /* Enemy Action Indicator */
        .enemy-action-bar {
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            padding: 10px 15px;
            margin-top: 10px;
        }

        .enemy-action-label {
            font-size: 0.9rem;
            color: #ff6b6b;
            margin-bottom: 5px;
        }

        .enemy-cooldown-bar {
            height: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            overflow: hidden;
        }

        .enemy-cooldown-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            transition: width 0.1s linear;
        }

        .enemy-action-bar.enemy-ready {
            background: rgba(231, 76, 60, 0.3);
            animation: enemy-pulse 0.3s ease-in-out infinite alternate;
        }

        .enemy-warning {
            color: #ff4444;
            font-weight: bold;
            animation: blink-warning 0.5s ease-in-out infinite alternate;
        }

        .enemy-fill-ready {
            background: linear-gradient(90deg, #ff4444, #ff0000) !important;
        }

        @keyframes enemy-pulse {
            from { box-shadow: 0 0 5px rgba(231, 76, 60, 0.5); }
            to { box-shadow: 0 0 15px rgba(231, 76, 60, 0.8); }
        }

        @keyframes blink-warning {
            from { opacity: 1; }
            to { opacity: 0.6; }
        }

        /* Save Error Toast */
        .save-error-toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #ef4444;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: bold;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* Chore Management Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* Pattern Lock Styles */
        .pattern-lock-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            margin: 16px 0;
            touch-action: none;
            user-select: none;
        }

        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 50px;
            padding: 20px;
            position: relative;
        }

        .pattern-dot {
            width: 28px;
            height: 28px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            position: relative;
            cursor: pointer;
            transition: all 0.15s ease;
            z-index: 2;
        }

        .pattern-dot::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: transparent;
        }

        .pattern-dot.selected {
            background: #a855f7;
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.8), 0 0 40px rgba(168, 85, 247, 0.4);
            transform: scale(1.4);
        }

        .pattern-dot.selected::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border: 3px solid rgba(168, 85, 247, 0.4);
            border-radius: 50%;
        }

        .pattern-dot.error {
            background: #ef4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.8);
        }

        .pattern-dot.success {
            background: #10b981;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.8);
        }

        .pattern-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .pattern-line {
            stroke: #a855f7;
            stroke-width: 4;
            stroke-linecap: round;
            fill: none;
        }

        .pattern-line.error {
            stroke: #ef4444;
        }

        .pattern-line.success {
            stroke: #10b981;
        }

        .pattern-hint {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.95rem;
            margin-top: 16px;
            text-align: center;
        }

        .pattern-dots-count {
            display: inline-block;
            background: rgba(168, 85, 247, 0.3);
            color: #a855f7;
            font-weight: bold;
            padding: 4px 12px;
            border-radius: 12px;
            margin-top: 8px;
        }

        .chore-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .chore-card:hover {
            border-color: #a855f7;
            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.15);
        }

        .chore-card.pending-approval {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #fffbeb, #fef3c7);
        }

        .chore-card.saved-later {
            opacity: 0.7;
            border-style: dashed;
        }

        .approval-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .approval-badge.pending {
            background: #fef3c7;
            color: #b45309;
        }

        .approval-badge.approved {
            background: #d1fae5;
            color: #047857;
        }

        .approval-badge.rejected {
            background: #fee2e2;
            color: #b91c1c;
        }

        .parent-review-card {
            background: white;
            border: 3px solid #e5e7eb;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .review-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .review-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .review-btn.pass {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .review-btn.pass:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .review-btn.fail {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .review-btn.fail:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .management-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .management-tab {
            flex: 1;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .management-tab.active {
            border-color: #a855f7;
            background: linear-gradient(135deg, #faf5ff, #fdf4ff);
            color: #7c3aed;
        }

        .request-approval-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .request-approval-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }

        .request-approval-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .input-field {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: #a855f7;
        }

        .gem-input {
            width: 80px;
            text-align: center;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggle-label {
            font-weight: 600;
            color: #374151;
        }

        /* Ship Upgrade System Styles */
        .upgrades-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .upgrade-card {
            background: linear-gradient(135deg, rgba(61, 35, 20, 0.9), rgba(93, 58, 26, 0.9));
            border: 2px solid var(--gold-dark);
            border-radius: 15px;
            padding: 15px;
        }

        .upgrade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .upgrade-name {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            color: var(--gold);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upgrade-level {
            background: var(--gold-dark);
            color: var(--wood-dark);
            padding: 3px 10px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .upgrade-description {
            font-size: 0.85rem;
            color: #bdc3c7;
            margin-bottom: 10px;
        }

        .upgrade-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .stat-current {
            font-size: 1.2rem;
            font-weight: 700;
            color: white;
        }

        .stat-arrow {
            color: var(--health-green);
            font-size: 1.2rem;
        }

        .stat-next {
            color: var(--health-green);
            font-size: 1.2rem;
            font-weight: 700;
        }

        .upgrade-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--gold-dark), var(--gold));
            border: none;
            border-radius: 10px;
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            font-weight: 700;
            color: var(--wood-dark);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .upgrade-btn:disabled {
            background: #555;
            color: #888;
            cursor: not-allowed;
        }

        .upgrade-btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 208, 63, 0.4);
        }

        .stats-summary {
            background: rgba(0,0,0,0.4);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .stats-summary h3 {
            font-family: 'Cinzel', serif;
            color: var(--gold);
            margin-bottom: 10px;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .stat-label {
            color: #bdc3c7;
        }

        .stat-value {
            color: var(--gold);
            font-weight: 700;
        }

        .log-gold { color: var(--gold); font-weight: 600; }

        /* Cooldown Progress Bar */
        .cooldown-progress-container {
            width: 100%;
            height: 24px;
            background: rgba(0,0,0,0.5);
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid var(--gold-dark);
            position: relative;
        }

        .cooldown-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--fire-orange), #f39c12);
            transition: width 0.1s linear;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .cooldown-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.3), transparent);
        }

        .cooldown-progress-bar.ready {
            background: linear-gradient(90deg, var(--health-green), #27ae60);
            animation: pulse-ready 0.5s ease-in-out infinite alternate;
        }

        @keyframes pulse-ready {
            from { opacity: 0.8; }
            to { opacity: 1; }
        }

        .cooldown-progress-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 700;
            font-size: 0.85rem;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            z-index: 1;
        }

        /* ============ MOBILE RESPONSIVE STYLES ============ */
        @media (max-width: 768px) {
            /* Navigation */
            .nav-btn {
                padding: 8px 12px;
                font-size: 0.75rem;
            }

            /* Battle view adjustments */
            .ship {
                max-width: 280px;
                height: 200px;
            }

            .battle-action-btn {
                min-height: 70px;
                min-width: 100px;
                padding: 10px;
            }

            .battle-action-btn .btn-label {
                font-size: 1rem;
            }

            .combat-log {
                max-height: 100px;
                font-size: 0.8rem;
            }

            /* Upgrade cards */
            .upgrades-container {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .upgrade-card {
                padding: 10px;
            }

            .upgrade-name {
                font-size: 0.85rem;
            }

            .upgrade-btn {
                padding: 6px 10px;
                font-size: 0.75rem;
            }

            /* Stats grid */
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            /* Modals */
            .modal-content {
                width: 95%;
                max-width: 400px;
                padding: 15px;
            }

            /* Chore cards */
            .grid.grid-cols-2 {
                gap: 8px;
            }
        }

        @media (max-width: 480px) {
            /* Extra small screens */
            .ship {
                max-width: 200px;
                height: 150px;
            }

            .battle-action-btn {
                min-height: 60px;
                min-width: 80px;
            }

            .upgrades-container {
                grid-template-columns: 1fr;
            }

            /* Stack battle ships vertically on very small screens */
            .grid.grid-cols-1.md\\:grid-cols-2 {
                gap: 12px;
            }

            /* Reduce heading sizes */
            h1 { font-size: 1.75rem !important; }
            h2 { font-size: 1.25rem !important; }
            h3 { font-size: 1rem !important; }

            /* Enemy action bar */
            .enemy-action-bar {
                padding: 6px 10px;
            }

            .enemy-action-label {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script>
    // ============ SOUND SYSTEM ============
    // Procedural audio using Web Audio API - no external files needed!
    
    const SoundSystem = (() => {
        let audioContext = null;
        let masterGain = null;
        let isUnlocked = false;
        let isMuted = false;
        
        // Initialize audio context (must be called from user interaction)
        const init = () => {
            if (audioContext) return;
            
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            masterGain = audioContext.createGain();
            masterGain.gain.value = 0.5;
            masterGain.connect(audioContext.destination);
            isUnlocked = true;
            
            // Sound system initialized
        };
        
        // Unlock audio on mobile (call from first user interaction)
        const unlock = () => {
            if (isUnlocked) return;
            init();
            
            // Play silent sound to unlock
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            gain.gain.value = 0;
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.start();
            osc.stop(audioContext.currentTime + 0.1);
        };
        
        const setMuted = (muted) => {
            isMuted = muted;
            if (masterGain) {
                masterGain.gain.value = muted ? 0 : 0.5;
            }
        };
        
        const toggleMute = () => {
            setMuted(!isMuted);
            return isMuted;
        };
        
        // Helper: Create oscillator with envelope
        const playTone = (freq, duration, type = 'sine', volume = 0.3, attack = 0.01, decay = 0.1) => {
            if (!audioContext || isMuted) return;
            
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioContext.currentTime);
            
            gain.gain.setValueAtTime(0, audioContext.currentTime);
            gain.gain.linearRampToValueAtTime(volume, audioContext.currentTime + attack);
            gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
            
            osc.connect(gain);
            gain.connect(masterGain);
            
            osc.start();
            osc.stop(audioContext.currentTime + duration);
        };
        
        // Helper: Create noise burst
        const playNoise = (duration, volume = 0.2, filterFreq = 1000) => {
            if (!audioContext || isMuted) return;
            
            const bufferSize = audioContext.sampleRate * duration;
            const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const data = buffer.getChannelData(0);
            
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }
            
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            
            const filter = audioContext.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = filterFreq;
            
            const gain = audioContext.createGain();
            gain.gain.setValueAtTime(volume, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
            
            source.connect(filter);
            filter.connect(gain);
            gain.connect(masterGain);
            
            source.start();
        };
        
        // ============ SOUND EFFECTS ============
        
        // UI Sounds
        const buttonClick = () => {
            if (!audioContext) return;
            playTone(800 + Math.random() * 100, 0.1, 'sine', 0.15, 0.005, 0.05);
        };
        
        const tabSwitch = () => {
            if (!audioContext) return;
            playTone(600, 0.08, 'sine', 0.1, 0.01, 0.03);
            setTimeout(() => playTone(800, 0.08, 'sine', 0.1, 0.01, 0.03), 50);
        };
        
        // Task/Chore Sounds
        const taskComplete = () => {
            if (!audioContext) return;
            // Ascending triumphant sound - like collecting a gem!
            const notes = [523, 659, 784, 1047]; // C5, E5, G5, C6
            notes.forEach((freq, i) => {
                setTimeout(() => playTone(freq, 0.2, 'sine', 0.25, 0.01, 0.1), i * 80);
            });
        };
        
        const streakBonus = () => {
            if (!audioContext) return;
            // Exciting fanfare for streak!
            playTone(440, 0.15, 'square', 0.15);
            setTimeout(() => playTone(554, 0.15, 'square', 0.15), 100);
            setTimeout(() => playTone(659, 0.15, 'square', 0.15), 200);
            setTimeout(() => playTone(880, 0.3, 'square', 0.2), 300);
        };
        
        // Battle Sounds
        const cannonFire = () => {
            if (!audioContext) return;
            // Deep boom + noise for cannon
            playTone(80, 0.4, 'sine', 0.5, 0.01, 0.2);
            playTone(60, 0.5, 'sine', 0.4, 0.02, 0.3);
            playNoise(0.3, 0.35, 800);
            // Add slight variation
            setTimeout(() => playTone(100 + Math.random() * 30, 0.2, 'triangle', 0.2), 50);
        };
        
        const shipHit = () => {
            if (!audioContext) return;
            // Impact sound with crunch
            playTone(150, 0.2, 'sawtooth', 0.3, 0.005, 0.1);
            playNoise(0.15, 0.25, 600);
            setTimeout(() => playTone(100, 0.15, 'sine', 0.2), 30);
        };
        
        const shipRepair = () => {
            if (!audioContext) return;
            // Hammer/repair sounds - playful
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    playTone(400 + i * 50, 0.08, 'square', 0.15, 0.005, 0.03);
                    playNoise(0.05, 0.1, 2000);
                }, i * 100);
            }
            setTimeout(() => playTone(600, 0.15, 'sine', 0.2), 350);
        };
        
        const enemyApproach = () => {
            if (!audioContext) return;
            // Ominous rising tone
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, audioContext.currentTime);
            osc.frequency.exponentialRampToValueAtTime(300, audioContext.currentTime + 0.5);
            
            gain.gain.setValueAtTime(0.15, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.6);
            
            osc.connect(gain);
            gain.connect(masterGain);
            osc.start();
            osc.stop(audioContext.currentTime + 0.6);
        };
        
        // Victory/Defeat Sounds
        const victory = () => {
            if (!audioContext) return;
            // Triumphant fanfare!
            const fanfare = [
                { freq: 523, time: 0 },     // C5
                { freq: 659, time: 150 },   // E5
                { freq: 784, time: 300 },   // G5
                { freq: 1047, time: 450 },  // C6
                { freq: 784, time: 600 },   // G5
                { freq: 1047, time: 750 },  // C6
            ];
            
            fanfare.forEach(note => {
                setTimeout(() => playTone(note.freq, 0.25, 'square', 0.2, 0.01, 0.15), note.time);
            });
        };
        
        const defeat = () => {
            if (!audioContext) return;
            // Sad descending tones
            const notes = [400, 350, 300, 200];
            notes.forEach((freq, i) => {
                setTimeout(() => playTone(freq, 0.3, 'sine', 0.2, 0.02, 0.2), i * 200);
            });
        };
        
        const levelUp = () => {
            if (!audioContext) return;
            // Magical ascending sweep
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    playTone(300 + i * 100, 0.15, 'sine', 0.15 + i * 0.02, 0.01, 0.1);
                }, i * 50);
            }
        };
        
        // Loot Sounds
        const lootRevealCommon = () => {
            if (!audioContext) return;
            playTone(440, 0.2, 'triangle', 0.2);
            setTimeout(() => playTone(550, 0.15, 'triangle', 0.15), 100);
        };
        
        const lootRevealRare = () => {
            if (!audioContext) return;
            // Magical sparkle
            playTone(600, 0.15, 'sine', 0.2);
            setTimeout(() => playTone(800, 0.15, 'sine', 0.2), 80);
            setTimeout(() => playTone(1000, 0.2, 'sine', 0.25), 160);
            setTimeout(() => playTone(1200, 0.25, 'sine', 0.2), 250);
        };
        
        const lootRevealLegendary = () => {
            if (!audioContext) return;
            // Epic reveal with bass and sparkles!
            playTone(100, 0.6, 'sine', 0.3);
            playNoise(0.3, 0.2, 1500);
            
            // Ascending magical tones
            const sparkle = [400, 600, 800, 1000, 1200, 1400];
            sparkle.forEach((freq, i) => {
                setTimeout(() => playTone(freq, 0.2, 'sine', 0.2), i * 60);
            });
            
            // Final chord
            setTimeout(() => {
                playTone(523, 0.4, 'sine', 0.2);
                playTone(659, 0.4, 'sine', 0.2);
                playTone(784, 0.4, 'sine', 0.2);
            }, 400);
        };
        
        // Ship/Unlock Sounds
        const shipUnlock = () => {
            if (!audioContext) return;
            // Triumphant horn-like sound
            playTone(220, 0.4, 'sawtooth', 0.15);
            playTone(277, 0.4, 'sawtooth', 0.15);
            setTimeout(() => {
                playTone(330, 0.5, 'sawtooth', 0.2);
                playTone(440, 0.5, 'sawtooth', 0.2);
            }, 300);
        };
        
        const figureheadUnlock = () => {
            if (!audioContext) return;
            // Mystical reveal
            playTone(200, 0.3, 'sine', 0.2);
            for (let i = 0; i < 5; i++) {
                setTimeout(() => playTone(400 + i * 200, 0.15, 'triangle', 0.15), 100 + i * 80);
            }
        };
        
        const purchase = () => {
            if (!audioContext) return;
            // Coin/gem purchase sound
            playTone(1200, 0.1, 'sine', 0.2, 0.005, 0.05);
            setTimeout(() => playTone(1500, 0.1, 'sine', 0.15, 0.005, 0.05), 60);
        };
        
        // Boss Sounds
        const bossAppear = () => {
            if (!audioContext) return;
            // Dramatic boss entrance
            playTone(80, 0.8, 'sawtooth', 0.3);
            playTone(100, 0.6, 'sine', 0.3);
            playNoise(0.4, 0.2, 500);
            
            setTimeout(() => {
                playTone(120, 0.3, 'sawtooth', 0.25);
                playTone(60, 0.5, 'sine', 0.35);
            }, 400);
            
            // Ominous pulse
            for (let i = 0; i < 4; i++) {
                setTimeout(() => playTone(80 + i * 10, 0.15, 'sine', 0.2), 600 + i * 150);
            }
        };
        
        const bossDefeated = () => {
            if (!audioContext) return;
            // Epic victory over boss!
            playNoise(0.5, 0.3, 1000);
            playTone(100, 0.6, 'sine', 0.3);
            
            const epicFanfare = [262, 330, 392, 523, 659, 784, 1047];
            epicFanfare.forEach((freq, i) => {
                setTimeout(() => playTone(freq, 0.25, 'square', 0.2), 200 + i * 100);
            });
        };
        
        return {
            init,
            unlock,
            setMuted,
            toggleMute,
            isMuted: () => isMuted,
            isReady: () => isUnlocked,
            
            // UI
            buttonClick,
            tabSwitch,
            
            // Tasks
            taskComplete,
            streakBonus,
            
            // Battle
            cannonFire,
            shipHit,
            shipRepair,
            enemyApproach,
            
            // Victory/Defeat
            victory,
            defeat,
            levelUp,
            
            // Loot
            lootRevealCommon,
            lootRevealRare,
            lootRevealLegendary,
            
            // Unlocks
            shipUnlock,
            figureheadUnlock,
            purchase
,
            
            // Boss
            bossAppear,
            bossDefeated
        };
    })();
    
    // Make available globally
    window.SoundSystem = SoundSystem;
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        
        // ============ GAME DATA ============
        
        const SHIP_PROGRESSION = [
            { id: 'starter', name: "Rusty Raft", cost: 0, size: "tiny", emoji: "üö£", description: "A humble beginning" },
            { id: 'sloop', name: "Swift Sloop", cost: 50, size: "small", emoji: "‚õµ", description: "Quick and nimble" },
            { id: 'brigantine', name: "Battle Brigantine", cost: 150, size: "medium", emoji: "üö¢", description: "Ready for action" },
            { id: 'galleon', name: "War Galleon", cost: 400, size: "large", emoji: "‚öîÔ∏è", description: "A force to reckon with" },
            { id: 'frigate', name: "Doom Frigate", cost: 800, size: "huge", emoji: "üè¥‚Äç‚ò†Ô∏è", description: "Terror of the seas" },
            { id: 'kraken', name: "Legendary Kraken", cost: 1500, size: "massive", emoji: "ü¶ë", description: "Mythical destroyer" },
            { id: 'destroyer', name: "Ultimate Destroyer", cost: 3000, size: "legendary", emoji: "üëë", description: "The pinnacle of power" }
        ];

        
            // Battle phase states for clearer state machine
            const BATTLE_PHASES = {
                IDLE: 'IDLE',           // Not in battle, can start new battle
                FIGHTING: 'FIGHTING',   // Active battle in progress
                VICTORY: 'VICTORY',     // Battle won, showing victory screen
                DEFEAT: 'DEFEAT'        // Battle lost, showing defeat screen
            };

const LOOT_TABLES = {
            hull: {
                common: [
                    { name: "Iron Nails", power: 5, emoji: "üî©" },
                    { name: "Wooden Planks", power: 3, emoji: "ü™µ" },
                    { name: "Tar Coating", power: 4, emoji: "üõ¢Ô∏è¬è" }
                ],
                rare: [
                    { name: "Steel Plating", power: 15, emoji: "üõ°Ô∏è¬è" },
                    { name: "Reinforced Beams", power: 12, emoji: "√¢≈°‚Ñ¢Ô∏è¬è" },
                    { name: "Copper Lining", power: 10, emoji: "ü•â" }
                ],
                legendary: [
                    { name: "Mythril Hull", power: 30, emoji: "üíé" },
                    { name: "Dragon Scale Armor", power: 35, emoji: "üêâ" },
                    { name: "Enchanted Timber", power: 28, emoji: "‚ú®" }
                ]
            },
            sails: {
                common: [
                    { name: "Canvas Scraps", power: 3, emoji: "üßµ" },
                    { name: "Cotton Sails", power: 4, emoji: "üè≥Ô∏è" },
                    { name: "Hemp Rigging", power: 5, emoji: "ü™¢" }
                ],
                rare: [
                    { name: "Silk Sails", power: 10, emoji: "üéÄ" },
                    { name: "Spider Silk Weave", power: 12, emoji: "üï∏Ô∏è¬è" },
                    { name: "Storm Sails", power: 14, emoji: "‚õàÔ∏è" }
                ],
                legendary: [
                    { name: "Wind Spirit Sails", power: 25, emoji: "üå¨Ô∏è¬è" },
                    { name: "Phoenix Feather Sails", power: 30, emoji: "üî•" },
                    { name: "Void Sails", power: 28, emoji: "üåå" }
                ]
            },
            cannons: {
                common: [
                    { name: "Gunpowder", power: 2, emoji: "üí•" },
                    { name: "Iron Cannonballs", power: 3, emoji: "√¢≈°¬´" },
                    { name: "Basic Fuses", power: 4, emoji: "üß®" }
                ],
                rare: [
                    { name: "Explosive Rounds", power: 8, emoji: "üí£" },
                    { name: "Chain Shot", power: 10, emoji: "‚õìÔ∏è" },
                    { name: "Grape Shot", power: 9, emoji: "üçá" }
                ],
                legendary: [
                    { name: "Dragon Cannons", power: 20, emoji: "üê≤" },
                    { name: "Thunder Barrels", power: 22, emoji: "‚ö°" },
                    { name: "Kraken Ink Bombs", power: 25, emoji: "ü¶ë" }
                ]
            }
        };

        // Boss every 10 levels
        const BOSS_BATTLES = {
            10: {
                name: "Ghost Captain Morgan",
                healthMultiplier: 3,
                emoji: "üíª",
                figurehead: { id: 'golden_mermaid', name: "Golden Mermaid", emoji: "üßú‚Äç‚ôÄÔ∏è¬è", description: "Lucky Treasure Finder" }
            },
            20: {
                name: "The Kraken Mother",
                healthMultiplier: 3.5,
                emoji: "ü¶ë",
                figurehead: { id: 'dragon_skull', name: "Dragon Skull", emoji: "üêâ", description: "Fear the Dragon" }
            },
            30: {
                name: "Admiral Blackbeard's Ghost",
                healthMultiplier: 4,
                emoji: "üíÄ",
                figurehead: { id: 'phoenix', name: "Phoenix Rising", emoji: "üî•", description: "Never Surrender" }
            },
            40: {
                name: "The Sea Serpent King",
                healthMultiplier: 4.5,
                emoji: "üêç",
                figurehead: { id: 'serpent', name: "Serpent Crown", emoji: "üêç", description: "Ruler of the Deep" }
            },
            50: {
                name: "The Dread Pizza",
                healthMultiplier: 5,
                emoji: "üçï",
                figurehead: { id: 'pizza', name: "Pizza Slice", emoji: "üçï", description: "Deliciously Dangerous" }
            }
        };

        const INITIAL_TASKS = [
            { id: 1, name: 'Do the dishes', icon: 'üçΩÔ∏è', completed: false, points: 5, repeatType: 'daily' },
            { id: 2, name: 'Clean your room', icon: 'üõèÔ∏è', completed: false, points: 10, repeatType: 'daily' },
            { id: 3, name: 'Take care of the cat', icon: 'üê±', completed: false, points: 5, repeatType: 'multiple' },
            { id: 4, name: 'Practice music', icon: 'üé∏', completed: false, points: 8, repeatType: 'daily' }
        ];

        const STORE_ITEMS = [
            { id: 'cool', name: 'Cool Skin', type: 'skin', price: 15, emoji: 'üòé' },
            { id: 'happy', name: 'Happy Skin', type: 'skin', price: 15, emoji: 'üòä' },
            { id: 'star', name: 'Star Skin', type: 'skin', price: 20, emoji: '‚≠ê' },
            { id: 'superhero', name: 'Superhero Outfit', type: 'outfit', price: 25, emoji: 'ü¶∏' },
            { id: 'wizard', name: 'Wizard Outfit', type: 'outfit', price: 25, emoji: 'üßô' },
            { id: 'ninja', name: 'Ninja Outfit', type: 'outfit', price: 30, emoji: 'ü•∑' },
            { id: 'crown', name: 'Royal Crown', type: 'accessory', price: 20, emoji: 'üëë' },
            { id: 'sunglasses', name: 'Cool Sunglasses', type: 'accessory', price: 15, emoji: 'üï∂Ô∏è¬è' },
            { id: 'hat', name: 'Party Hat', type: 'accessory', price: 12, emoji: 'üé©' }
        ];

        // ============ UTILITY FUNCTIONS ============

        const saveGame = (state, onError) => {
            try {
                const data = JSON.stringify({
                    ...state,
                    savedAt: new Date().toISOString()
                });
                localStorage.setItem('chorequest_save_v3', data);
                return true;
            } catch (e) {
                console.error('Failed to save game:', e);
                if (onError) onError(e.message || 'Failed to save progress');
                return false;
            }
        };

        const loadGame = () => {
            try {
                const saved = localStorage.getItem('chorequest_save_v3');
                if (!saved) return null;
                
                const data = JSON.parse(saved);
                
                // Basic validation - ensure critical fields exist
                if (typeof data !== 'object' || data === null) {
                    console.warn('Invalid save data format');
                    return null;
                }
                
                // Ensure arrays are arrays (prevents crashes)
                if (data.tasks && !Array.isArray(data.tasks)) data.tasks = [];
                if (data.inventory && !Array.isArray(data.inventory)) data.inventory = [];
                if (data.ownedShips && !Array.isArray(data.ownedShips)) data.ownedShips = ['starter'];
                if (data.lootInventory && !Array.isArray(data.lootInventory)) data.lootInventory = [];
                
                return data;
            } catch (e) {
                console.error('Failed to load game:', e);
                return null;
            }
        };

        const rollLoot = (level, battlesSinceRare) => {
            const roll = Math.random();
            let rarity;
            
            if (battlesSinceRare >= 10) {
                rarity = roll < 0.3 ? 'legendary' : 'rare';
            } else if (roll <= 0.05) {
                rarity = 'legendary';
            } else if (roll <= 0.30) {
                rarity = 'rare';
            } else {
                rarity = 'common';
            }

            const types = ['hull', 'sails', 'cannons'];
            const type = types[Math.floor(Math.random() * types.length)];
            const items = LOOT_TABLES[type][rarity];
            const item = items[Math.floor(Math.random() * items.length)];

            return { ...item, type, rarity };
        };

        const createConfetti = () => {
            // Clear any existing confetti first to prevent accumulation
            document.querySelectorAll('.confetti-piece').forEach(p => p.remove());
            
            const colors = ['#ff6b35', '#f4d03f', '#9333ea', '#3b82f6', '#51cf66', '#ff69b4'];
            const confettiPieces = [];
            
            for (let i = 0; i < 50; i++) {
                const piece = document.createElement('div');
                piece.className = 'confetti-piece';
                piece.style.left = Math.random() * 100 + 'vw';
                piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                piece.style.animationDelay = Math.random() * 0.5 + 's';
                piece.style.transform = `rotate(${Math.random() * 360}deg)`;
                document.body.appendChild(piece);
                confettiPieces.push(piece);
            }

            setTimeout(() => confettiPieces.forEach(p => p.remove()), 3500);
        };

        // Calculate which 10-level block a level belongs to
        const getLevelBlock = (level) => Math.floor((level - 1) / 10);
        const getBlockStart = (level) => getLevelBlock(level) * 10 + 1;

        // ============ MAIN APP ============
        
        const ChoreQuestApp = () => {
            const savedGame = loadGame();
            
            const [currentView, setCurrentView] = useState('tasks');
            const [gems, setGems] = useState(savedGame?.gems || 25);
            const [loot, setLoot] = useState(savedGame?.loot || 0);
            const [tasks, setTasks] = useState(savedGame?.tasks || INITIAL_TASKS);
            const [streak, setStreak] = useState(savedGame?.streak || 0);
            const [lastPlayDate, setLastPlayDate] = useState(savedGame?.lastPlayDate || null);
            const [soundEnabled, setSoundEnabled] = useState(savedGame?.soundEnabled !== false);
            const [saveError, setSaveError] = useState(null);
            
            const [avatar, setAvatar] = useState(savedGame?.avatar || {
                skin: 'default', outfit: 'casual', accessory: 'none'
            });
            
            const [inventory, setInventory] = useState(savedGame?.inventory || ['default', 'casual', 'none']);
            const [celebration, setCelebration] = useState(false);
            
            const [currentShip, setCurrentShip] = useState(savedGame?.currentShip || 'starter');
            const [ownedShips, setOwnedShips] = useState(savedGame?.ownedShips || ['starter']);
            const [equipped, setEquipped] = useState(savedGame?.equipped || {
                hull: null, sails: null, cannons: null, figurehead: null
            });
            const [lootInventory, setLootInventory] = useState(savedGame?.lootInventory || []);
            const [figureheads, setFigureheads] = useState(savedGame?.figureheads || []);
            const [battlesSinceRare, setBattlesSinceRare] = useState(savedGame?.battlesSinceRare || 0);

            // Ship upgrade stats
            const [shipStats, setShipStats] = useState(savedGame?.shipStats || {
                firepower: { level: 1, base: 15, perLevel: 5 },
                crew: { level: 1, base: 0, perLevel: 5 },      // % cooldown reduction
                hull: { level: 1, base: 100, perLevel: 20 },
                repair: { level: 1, base: 20, perLevel: 5 }
            });

            // Upgrade cost calculation (triangular formula)
            const getUpgradeCost = (level) => {
                const base = 10;
                return base * (level + 1);
            };

            // Get computed stats from upgrade levels
            const getComputedStats = useCallback(() => {
                return {
                    damage: shipStats.firepower.base + (shipStats.firepower.level - 1) * shipStats.firepower.perLevel,
                    cooldownReduction: shipStats.crew.base + (shipStats.crew.level - 1) * shipStats.crew.perLevel,
                    maxHealth: shipStats.hull.base + (shipStats.hull.level - 1) * shipStats.hull.perLevel,
                    repairAmount: shipStats.repair.base + (shipStats.repair.level - 1) * shipStats.repair.perLevel
                };
            }, [shipStats]);

            // Purchase upgrade
            const purchaseUpgrade = (statKey) => {
                const stat = shipStats[statKey];
                const cost = getUpgradeCost(stat.level);

                if (loot >= cost) {
                    setLoot(l => l - cost);
                    setShipStats(prev => ({
                        ...prev,
                        [statKey]: { ...prev[statKey], level: prev[statKey].level + 1 }
                    }));
                    window.SoundSystem.levelUp();
                }
            };

            const [gameState, setGameState] = useState({
                level: savedGame?.gameState?.level || 1,
                player: {
                    maxHealth: 100, health: 100, cannons: 1, crew: 5,
                    size: SHIP_PROGRESSION.find(s => s.id === (savedGame?.currentShip || 'starter'))?.size || 'tiny',
                    damage: 15, repairAmount: 20
                },
                enemy: {
                    maxHealth: 50, health: 50, cannons: 1, crew: 3,
                    size: 'Small', damage: 10, fireCooldown: 3.5, repairThreshold: 0.4
                },
                battlePhase: BATTLE_PHASES.IDLE, combatLog: [],
                isBoss: false, bossData: null,
                // Real-time battle cooldowns
                playerCooldown: 0,
                enemyCooldown: 0,
                baseCooldown: 3.0
            });

            const [autoBattle, setAutoBattle] = useState(savedGame?.autoBattle || false);
            const lastTimeRef = useRef(0);
            const gameLoopRef = useRef(null);
            const actionInProgressRef = useRef(false);  // Prevents multi-click bugs in attack/repair

            const [showLootReveal, setShowLootReveal] = useState(false);
            const [currentLoot, setCurrentLoot] = useState(null);
            const [lootRevealed, setLootRevealed] = useState(false);
            // Victory/Defeat now handled by gameState.battlePhase
            const [showBossIntro, setShowBossIntro] = useState(false);
            const [showFigureheadUnlock, setShowFigureheadUnlock] = useState(false);
            const [unlockedFigurehead, setUnlockedFigurehead] = useState(null);
            const [showShipUnlock, setShowShipUnlock] = useState(false);
            const [unlockedShip, setUnlockedShip] = useState(null);

            // ============ CHORE MANAGEMENT STATE ============
            const [parentPassword, setParentPassword] = useState(savedGame?.parentPassword || null);
            const [showPasswordSetup, setShowPasswordSetup] = useState(false);
            const [showPasswordEntry, setShowPasswordEntry] = useState(false);
            const [passwordError, setPasswordError] = useState(false);
            const [passwordSuccess, setPasswordSuccess] = useState(false);
            const [pendingPasswordAction, setPendingPasswordAction] = useState(null);

            // Pattern lock state
            const [patternInput, setPatternInput] = useState([]);
            const [isDrawingPattern, setIsDrawingPattern] = useState(false);
            const [currentPoint, setCurrentPoint] = useState(null);
            const patternGridRef = useRef(null);
            const dotRefs = useRef([]);

            const [savedChores, setSavedChores] = useState(savedGame?.savedChores || []);
            const [pendingApproval, setPendingApproval] = useState(savedGame?.pendingApproval || []);
            const [showChoreManagement, setShowChoreManagement] = useState(false);
            const [showParentReview, setShowParentReview] = useState(false);
            const [choreManagementTab, setChoreManagementTab] = useState('active');
            const [reviewDecisions, setReviewDecisions] = useState({});

            const [editingChore, setEditingChore] = useState(null);
            const [showChoreEditor, setShowChoreEditor] = useState(false);
            const [choreForm, setChoreForm] = useState({ name: '', icon: 'üìã', points: 5, repeatType: 'daily' });

            const playerShipRef = useRef(null);
            const enemyShipRef = useRef(null);

            // Initialize sound on first interaction
            useEffect(() => {
                const handleFirstInteraction = () => {
                    window.SoundSystem.unlock();
                    if (!soundEnabled) {
                        window.SoundSystem.setMuted(true);
                    }
                    document.removeEventListener('click', handleFirstInteraction);
                    document.removeEventListener('touchstart', handleFirstInteraction);
                };
                
                document.addEventListener('click', handleFirstInteraction);
                document.addEventListener('touchstart', handleFirstInteraction);
                
                return () => {
                    document.removeEventListener('click', handleFirstInteraction);
                    document.removeEventListener('touchstart', handleFirstInteraction);
                };
            }, []);

            const getTotalPower = useCallback(() => {
                let power = 0;
                if (equipped.hull) power += equipped.hull.power;
                if (equipped.sails) power += equipped.sails.power;
                if (equipped.cannons) power += equipped.cannons.power;
                return power;
            }, [equipped]);

            // Save game whenever state changes
            useEffect(() => {
                saveGame({
                    gems, loot, tasks, streak, lastPlayDate, avatar, inventory,
                    currentShip, ownedShips, equipped, lootInventory, figureheads,
                    battlesSinceRare, soundEnabled, autoBattle, shipStats,
                    parentPassword, savedChores, pendingApproval,
                    gameState: { level: gameState.level }
                }, (errorMsg) => {
                    setSaveError(errorMsg);
                    // Auto-clear error after 5 seconds
                    setTimeout(() => setSaveError(null), 5000);
                });
            }, [gems, loot, tasks, streak, avatar, inventory, currentShip, ownedShips, equipped, lootInventory, figureheads, battlesSinceRare, gameState.level, soundEnabled, autoBattle, shipStats, parentPassword, savedChores, pendingApproval]);

            // Daily reset
            useEffect(() => {
                const today = new Date().toDateString();
                if (lastPlayDate && lastPlayDate !== today) {
                    // Reset daily and multiple tasks, remove completed one-time tasks
                    setTasks(tasks.filter(task => {
                        // Remove completed one-time tasks
                        if (task.repeatType === 'once' && task.completed) return false;
                        return true;
                    }).map(task => {
                        // Reset daily and multiple tasks
                        if (task.repeatType === 'daily' || task.repeatType === 'multiple') {
                            return { ...task, completed: false };
                        }
                        return task;
                    }));
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    if (lastPlayDate === yesterday.toDateString()) {
                        setStreak(s => s + 1);
                        window.SoundSystem.streakBonus();
                    } else {
                        setStreak(0);
                    }
                }
                setLastPlayDate(today);
            }, []);

            // ============ SOUND TOGGLE ============

            const toggleSound = () => {
                const newMuted = window.SoundSystem.toggleMute();
                setSoundEnabled(!newMuted);
                if (!newMuted) {
                    window.SoundSystem.buttonClick();
                }
            };

            // ============ REAL-TIME BATTLE HELPERS ============

            const getPlayerCooldown = useCallback(() => {
                const shipIndex = SHIP_PROGRESSION.findIndex(s => s.id === currentShip);
                const shipBonus = shipIndex * 5; // 5% reduction per ship tier
                const crewBonus = shipStats.crew.base + (shipStats.crew.level - 1) * shipStats.crew.perLevel;
                const totalReduction = (shipBonus + crewBonus) / 100;
                return Math.max(gameState.baseCooldown * (1 - totalReduction), 0.8);
            }, [currentShip, gameState.baseCooldown, shipStats.crew]);

            // ============ REAL-TIME GAME LOOP ============

            useEffect(() => {
                if (gameState.battlePhase !== BATTLE_PHASES.FIGHTING) {
                    lastTimeRef.current = 0;
                    return;
                }

                const runGameLoop = (currentTime) => {
                    if (!lastTimeRef.current) lastTimeRef.current = currentTime;
                    const delta = (currentTime - lastTimeRef.current) / 1000;
                    lastTimeRef.current = currentTime;

                    setGameState(prev => {
                        if (prev.battlePhase !== BATTLE_PHASES.FIGHTING) return prev;

                        let newPlayerCooldown = Math.max(0, prev.playerCooldown - delta);
                        let newEnemyCooldown = Math.max(0, prev.enemyCooldown - delta);
                        let newPlayerHealth = prev.player.health;
                        let newEnemyHealth = prev.enemy.health;
                        let newCombatLog = [...prev.combatLog];

                        // Enemy AI action when cooldown is ready
                        if (newEnemyCooldown <= 0 && prev.enemy.health > 0 && prev.player.health > 0) {
                            const healthPct = prev.enemy.health / prev.enemy.maxHealth;

                            if (healthPct < prev.enemy.repairThreshold && prev.enemy.health < prev.enemy.maxHealth) {
                                // Enemy repairs
                                const healAmount = Math.min(10 + Math.floor(prev.level / 2) * 5, prev.enemy.maxHealth - prev.enemy.health);
                                newEnemyHealth = prev.enemy.health + healAmount;
                                newCombatLog = [`üîß Enemy repairs! <span class="log-heal">+${healAmount}</span> HP!`, ...newCombatLog].slice(0, 10);
                                window.SoundSystem.shipRepair();
                            } else {
                                // Enemy attacks
                                const damage = prev.enemy.damage + Math.random() * 3;
                                newPlayerHealth = Math.max(0, prev.player.health - damage);
                                newCombatLog = [`üí• Enemy fires! <span class="log-damage">-${Math.floor(damage)}</span> damage!`, ...newCombatLog].slice(0, 10);
                                window.SoundSystem.cannonFire();
                                setTimeout(() => window.SoundSystem.shipHit(), 200);

                                // Animate player damage
                                if (playerShipRef.current) {
                                    playerShipRef.current.classList.add('damaged');
                                    setTimeout(() => {
                                        if (playerShipRef.current) playerShipRef.current.classList.remove('damaged');
                                    }, 300);
                                }
                                showDamageNumber('player', damage);
                            }
                            newEnemyCooldown = prev.enemy.fireCooldown;
                        }

                        // Check for defeat
                        if (newPlayerHealth <= 0 && prev.player.health > 0) {
                            setTimeout(() => {
                                window.SoundSystem.defeat();
                            }, 500);
                            return {
                                ...prev,
                                battlePhase: BATTLE_PHASES.DEFEAT,
                                player: { ...prev.player, health: 0 },
                                enemy: { ...prev.enemy, health: newEnemyHealth },
                                playerCooldown: newPlayerCooldown,
                                enemyCooldown: newEnemyCooldown,
                                combatLog: newCombatLog
                            };
                        }

                        return {
                            ...prev,
                            player: { ...prev.player, health: newPlayerHealth },
                            enemy: { ...prev.enemy, health: newEnemyHealth },
                            playerCooldown: newPlayerCooldown,
                            enemyCooldown: newEnemyCooldown,
                            combatLog: newCombatLog
                        };
                    });

                    // Auto-battle logic
                    if (autoBattle) {
                        setGameState(prev => {
                            if (prev.battlePhase !== BATTLE_PHASES.FIGHTING || prev.playerCooldown > 0) return prev;

                            const playerHealthPct = prev.player.health / prev.player.maxHealth;
                            if (playerHealthPct < 0.5 && prev.player.health < prev.player.maxHealth) {
                                // Auto repair when low
                                setTimeout(() => playerRepair(), 0);
                            } else {
                                // Auto attack
                                setTimeout(() => playerAttack(), 0);
                            }
                            return prev;
                        });
                    }

                    gameLoopRef.current = requestAnimationFrame(runGameLoop);
                };

                gameLoopRef.current = requestAnimationFrame(runGameLoop);

                return () => {
                    if (gameLoopRef.current) {
                        cancelAnimationFrame(gameLoopRef.current);
                    }
                };
            }, [gameState.battlePhase, autoBattle]);

            // ============ TASK HANDLERS ============

            const toggleTask = (id) => {
                const task = tasks.find(t => t.id === id);
                // For 'multiple' type tasks, allow completion even if already completed today
                if (!task || (task.completed && task.repeatType !== 'multiple')) return;

                // Mark task as completed but add to pending approval
                const streakBonus = Math.floor(streak / 5);
                const totalPoints = task.points + streakBonus;

                // Add to pending approval queue with unique ID for this completion
                setPendingApproval(prev => [...prev, {
                    ...task,
                    approvalId: `${task.id}-${Date.now()}`,
                    totalPoints,
                    streakBonus,
                    completedAt: new Date().toISOString()
                }]);

                // For 'multiple' type, don't mark as completed so it can be done again
                // For 'once' and 'daily', mark as completed
                if (task.repeatType !== 'multiple') {
                    setTasks(tasks.map(t =>
                        t.id === id ? { ...t, completed: true, pendingApproval: true } : t
                    ));
                }

                window.SoundSystem.buttonClick();
            };

            // ============ CHORE MANAGEMENT HANDLERS ============

            const CHORE_ICONS = ['üìã', 'üßπ', 'üçΩÔ∏è', 'üõèÔ∏è', 'üêï', 'üê±', 'üß∫', 'üìö', 'üéπ', 'üå±', 'üóëÔ∏è', 'üöø', 'ü¶∑', 'üëï', 'üß∏', '‚úèÔ∏è'];

            // Pattern lock helper functions
            const getDotCenter = (dotIndex) => {
                const dot = dotRefs.current[dotIndex];
                const grid = patternGridRef.current;
                if (!dot || !grid) return null;

                const dotRect = dot.getBoundingClientRect();
                const gridRect = grid.getBoundingClientRect();

                return {
                    x: dotRect.left + dotRect.width / 2 - gridRect.left,
                    y: dotRect.top + dotRect.height / 2 - gridRect.top
                };
            };

            const getPatternPath = (pattern, currentPt = null) => {
                if (pattern.length === 0) return '';

                const points = pattern.map(idx => getDotCenter(idx)).filter(Boolean);
                if (points.length === 0) return '';

                let path = `M ${points[0].x} ${points[0].y}`;
                for (let i = 1; i < points.length; i++) {
                    path += ` L ${points[i].x} ${points[i].y}`;
                }

                if (currentPt && points.length > 0) {
                    path += ` L ${currentPt.x} ${currentPt.y}`;
                }

                return path;
            };

            const verifyPattern = (input) => {
                if (!parentPassword || !Array.isArray(parentPassword)) return false;
                if (input.length !== parentPassword.length) return false;
                return input.every((dot, idx) => dot === parentPassword[idx]);
            };

            const handlePatternStart = (dotIndex, e) => {
                e.preventDefault();
                setIsDrawingPattern(true);
                setPatternInput([dotIndex]);
                setPasswordError(false);
                setPasswordSuccess(false);
                window.SoundSystem.buttonClick();
            };

            const handlePatternMove = (e) => {
                if (!isDrawingPattern || !patternGridRef.current) return;

                const grid = patternGridRef.current;
                const gridRect = grid.getBoundingClientRect();

                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;

                setCurrentPoint({
                    x: clientX - gridRect.left,
                    y: clientY - gridRect.top
                });

                // Check if we're over a new dot
                dotRefs.current.forEach((dot, idx) => {
                    if (!dot || patternInput.includes(idx)) return;

                    const dotRect = dot.getBoundingClientRect();
                    const dotCenterX = dotRect.left + dotRect.width / 2;
                    const dotCenterY = dotRect.top + dotRect.height / 2;
                    const distance = Math.sqrt(
                        Math.pow(clientX - dotCenterX, 2) +
                        Math.pow(clientY - dotCenterY, 2)
                    );

                    if (distance < 35) {
                        setPatternInput(prev => [...prev, idx]);
                        window.SoundSystem.buttonClick();
                    }
                });
            };

            const handlePatternEnd = () => {
                if (!isDrawingPattern) return;

                setIsDrawingPattern(false);
                setCurrentPoint(null);

                if (patternInput.length < 4) {
                    // Pattern too short
                    setPatternInput([]);
                    return;
                }

                if (showPasswordSetup) {
                    // Setting up new password
                    setParentPassword([...patternInput]);
                    setPasswordSuccess(true);
                    window.SoundSystem.taskComplete();

                    setTimeout(() => {
                        setShowPasswordSetup(false);
                        setPatternInput([]);
                        setPasswordSuccess(false);
                        if (pendingPasswordAction) {
                            pendingPasswordAction();
                            setPendingPasswordAction(null);
                        }
                    }, 600);
                } else {
                    // Verifying password
                    if (verifyPattern(patternInput)) {
                        setPasswordSuccess(true);
                        window.SoundSystem.taskComplete();

                        setTimeout(() => {
                            setShowPasswordEntry(false);
                            setPatternInput([]);
                            setPasswordSuccess(false);
                            if (pendingPasswordAction) {
                                pendingPasswordAction();
                                setPendingPasswordAction(null);
                            }
                        }, 600);
                    } else {
                        setPasswordError(true);
                        window.SoundSystem.defeat();

                        setTimeout(() => {
                            setPatternInput([]);
                            setPasswordError(false);
                        }, 800);
                    }
                }
            };

            const clearPatternInput = () => {
                setPatternInput([]);
                setPasswordError(false);
                setPasswordSuccess(false);
            };

            const requestParentAccess = (action) => {
                setPendingPasswordAction(() => action);
                setPatternInput([]);
                setPasswordError(false);
                setPasswordSuccess(false);
                if (!parentPassword) {
                    setShowPasswordSetup(true);
                } else {
                    setShowPasswordEntry(true);
                }
            };

            const openChoreManagement = () => {
                requestParentAccess(() => setShowChoreManagement(true));
            };

            const openParentReview = () => {
                requestParentAccess(() => {
                    setReviewDecisions({});
                    setShowParentReview(true);
                });
            };

            const addNewChore = () => {
                const newChore = {
                    id: Date.now(),
                    name: choreForm.name.trim(),
                    icon: choreForm.icon,
                    points: parseInt(choreForm.points) || 5,
                    repeatType: choreForm.repeatType,
                    completed: false
                };

                if (!newChore.name) return;

                setTasks(prev => [...prev, newChore]);
                setChoreForm({ name: '', icon: 'üìã', points: 5, repeatType: 'daily' });
                setShowChoreEditor(false);
                window.SoundSystem.buttonClick();
            };

            const updateChore = () => {
                if (!editingChore) return;

                setTasks(prev => prev.map(task =>
                    task.id === editingChore.id ? {
                        ...task,
                        name: choreForm.name.trim() || task.name,
                        icon: choreForm.icon,
                        points: parseInt(choreForm.points) || task.points,
                        repeatType: choreForm.repeatType
                    } : task
                ));

                setEditingChore(null);
                setShowChoreEditor(false);
                setChoreForm({ name: '', icon: 'üìã', points: 5, repeatType: 'daily' });
                window.SoundSystem.buttonClick();
            };

            const deleteChore = (choreId) => {
                setTasks(prev => prev.filter(t => t.id !== choreId));
                // Also remove from pending approval if there
                setPendingApproval(prev => prev.filter(t => t.id !== choreId));
                window.SoundSystem.buttonClick();
            };

            const saveChoreForLater = (choreId) => {
                const chore = tasks.find(t => t.id === choreId);
                if (!chore) return;

                setSavedChores(prev => [...prev, { ...chore, completed: false }]);
                setTasks(prev => prev.filter(t => t.id !== choreId));
                window.SoundSystem.buttonClick();
            };

            const restoreChore = (choreId) => {
                const chore = savedChores.find(c => c.id === choreId);
                if (!chore) return;

                setTasks(prev => [...prev, { ...chore, completed: false }]);
                setSavedChores(prev => prev.filter(c => c.id !== choreId));
                window.SoundSystem.buttonClick();
            };

            const openChoreEditor = (chore = null) => {
                if (chore) {
                    setEditingChore(chore);
                    setChoreForm({
                        name: chore.name,
                        icon: chore.icon,
                        points: chore.points,
                        repeatType: chore.repeatType || 'daily'
                    });
                } else {
                    setEditingChore(null);
                    setChoreForm({ name: '', icon: 'üìã', points: 5, repeatType: 'daily' });
                }
                setShowChoreEditor(true);
            };

            const setReviewDecision = (choreId, decision) => {
                setReviewDecisions(prev => ({ ...prev, [choreId]: decision }));
            };

            const submitReviews = () => {
                let gemsAwarded = 0;

                // Use approvalId for unique identification (supports multiple completions)
                pendingApproval.forEach(chore => {
                    const key = chore.approvalId || chore.id;
                    const decision = reviewDecisions[key];
                    if (decision === 'pass') {
                        gemsAwarded += chore.totalPoints;
                    }
                });

                // Award gems
                if (gemsAwarded > 0) {
                    setGems(g => g + gemsAwarded);
                    setCelebration(true);
                    window.SoundSystem.taskComplete();
                    setTimeout(() => setCelebration(false), 500);
                }

                // Get all reviewed keys
                const reviewedKeys = Object.keys(reviewDecisions);

                // Update tasks - mark reviewed ones as no longer pending
                // For 'multiple' type tasks, we don't mark as completed
                const reviewedTaskIds = new Set(
                    pendingApproval
                        .filter(p => reviewedKeys.includes(p.approvalId || String(p.id)))
                        .map(p => p.id)
                );

                setTasks(prev => prev.map(task => {
                    if (reviewedTaskIds.has(task.id) && task.repeatType !== 'multiple') {
                        const key = pendingApproval.find(p => p.id === task.id)?.approvalId || task.id;
                        const decision = reviewDecisions[key];
                        if (decision === 'fail') {
                            // Failed - reset to incomplete so child can redo
                            return { ...task, completed: false, pendingApproval: false };
                        }
                        // Passed - mark as fully completed
                        return { ...task, pendingApproval: false };
                    }
                    return task;
                }));

                // Remove reviewed items from pending approval using approvalId
                setPendingApproval(prev => prev.filter(p => {
                    const key = p.approvalId || String(p.id);
                    return !reviewedKeys.includes(key);
                }));

                setShowParentReview(false);
                setReviewDecisions({});
            };

            const hasPendingChores = pendingApproval.length > 0;

            // ============ SHOP HANDLERS ============
            
            const buyItem = (item) => {
                if (gems >= item.price && !inventory.includes(item.id)) {
                    setGems(g => g - item.price);
                    setInventory([...inventory, item.id]);
                    window.SoundSystem.purchase();
                    if (item.type === 'skin') setAvatar({ ...avatar, skin: item.id });
                    if (item.type === 'outfit') setAvatar({ ...avatar, outfit: item.id });
                    if (item.type === 'accessory') setAvatar({ ...avatar, accessory: item.id });
                }
            };

            const equipItem = (itemId, type) => {
                if (inventory.includes(itemId)) {
                    setAvatar({ ...avatar, [type]: itemId });
                    window.SoundSystem.buttonClick();
                }
            };

            // ============ SHIP HANDLERS ============

            const buyShip = (ship) => {
                if (gems >= ship.cost && !ownedShips.includes(ship.id)) {
                    setGems(g => g - ship.cost);
                    setOwnedShips([...ownedShips, ship.id]);
                    setCurrentShip(ship.id);
                    setUnlockedShip(ship);
                    setShowShipUnlock(true);
                    window.SoundSystem.shipUnlock();
                    createConfetti();
                }
            };

            const selectShip = (shipId) => {
                if (ownedShips.includes(shipId)) {
                    setCurrentShip(shipId);
                    window.SoundSystem.buttonClick();
                }
            };

            const equipLoot = (lootItem) => {
                setEquipped(prev => ({ ...prev, [lootItem.type]: lootItem }));
                window.SoundSystem.buttonClick();
            };

            const equipFigurehead = (figurehead) => {
                setEquipped(prev => ({ ...prev, figurehead: figurehead }));
                window.SoundSystem.buttonClick();
            };

            // ============ BATTLE HANDLERS ============

            const addLog = (message) => {
                setGameState(prev => ({
                    ...prev,
                    combatLog: [message, ...prev.combatLog].slice(0, 10)
                }));
            };

            // Safe log renderer - parses log strings and renders without dangerouslySetInnerHTML
            const renderLogEntry = (log) => {
                // Simple approach: split by span tags and reconstruct
                if (!log.includes('<span')) {
                    return log;
                }
                
                // Replace span tags with markers, then split
                const processed = log
                    .replace(/<span class="log-damage">([^<]+)<\/span>/g, '|||DAMAGE:$1|||')
                    .replace(/<span class="log-heal">([^<]+)<\/span>/g, '|||HEAL:$1|||');
                
                const parts = processed.split('|||').filter(p => p);
                
                return parts.map((part, idx) => {
                    if (part.startsWith('DAMAGE:')) {
                        return <span key={idx} className="log-damage">{part.slice(7)}</span>;
                    } else if (part.startsWith('HEAL:')) {
                        return <span key={idx} className="log-heal">{part.slice(5)}</span>;
                    }
                    return <span key={idx}>{part}</span>;
                });
            };

            const showDamageNumber = (target, damage, isHeal = false) => {
                const shipElement = target === 'player' ? playerShipRef.current : enemyShipRef.current;
                if (!shipElement) return;

                const damageNum = document.createElement('div');
                damageNum.className = 'damage-number';
                damageNum.textContent = isHeal ? `+${Math.floor(damage)}` : `-${Math.floor(damage)}`;
                if (isHeal) {
                    damageNum.style.color = '#51cf66';
                }
                
                const rect = shipElement.getBoundingClientRect();
                // Constrain to viewport to prevent off-screen numbers
                const left = Math.max(10, Math.min(window.innerWidth - 70, rect.left + rect.width / 2 - 30));
                const top = Math.max(10, rect.top + 50);
                damageNum.style.left = `${left}px`;
                damageNum.style.top = `${top}px`;
                
                document.body.appendChild(damageNum);
                
                // Use animation end event with fallback timeout for cleanup
                const cleanup = () => damageNum.remove();
                damageNum.addEventListener('animationend', cleanup, { once: true });
                setTimeout(cleanup, 1500); // Fallback cleanup
            };

            const startBattle = (overrideLevel = null) => {
                const level = overrideLevel !== null ? overrideLevel : gameState.level;
                const isBoss = level % 10 === 0 && BOSS_BATTLES[level];
                const bossData = isBoss ? BOSS_BATTLES[level] : null;
                
                const currentShipData = SHIP_PROGRESSION.find(s => s.id === currentShip);
                const shipIndex = SHIP_PROGRESSION.findIndex(s => s.id === currentShip);
                
                // Get upgrade-based stats
                const upgradeStats = getComputedStats();

                // Combine ship tier bonuses with upgrade bonuses
                const baseDamage = upgradeStats.damage + (shipIndex * 5) + getTotalPower();
                const baseHealth = upgradeStats.maxHealth + (shipIndex * 25);
                const baseRepair = upgradeStats.repairAmount + (shipIndex * 5);
                
                const scaleFactor = 1 + (level * 0.3);
                const bossMultiplier = isBoss ? bossData.healthMultiplier : 1;
                
                if (isBoss) {
                    setShowBossIntro(true);
                    window.SoundSystem.bossAppear();
                    setTimeout(() => {
                        setShowBossIntro(false);
                        actuallyStartBattle();
                    }, 2500);
                } else {
                    window.SoundSystem.enemyApproach();
                    actuallyStartBattle();
                }

                function actuallyStartBattle() {
                    setGameState(prev => ({
                        ...prev,
                        level: level,
                        battlePhase: BATTLE_PHASES.FIGHTING,
                        isBoss,
                        playerCooldown: 0,
                        enemyCooldown: (isBoss ? 4.0 : Math.max(3.5 - level * 0.03, 2.5)) * 0.5,
                        bossData,
                        player: {
                            maxHealth: baseHealth,
                            health: baseHealth,
                            cannons: 1 + shipIndex,
                            crew: 5 + shipIndex * 2,
                            size: currentShipData?.size || 'tiny',
                            damage: baseDamage,
                            repairAmount: baseRepair
                        },
                        enemy: {
                            maxHealth: Math.floor(50 * scaleFactor * bossMultiplier),
                            health: Math.floor(50 * scaleFactor * bossMultiplier),
                            cannons: Math.floor(1 + level / 3),
                            crew: Math.floor(3 + level / 2),
                            size: level > 8 ? 'Legendary' : level > 6 ? 'Massive' : level > 4 ? 'Large' : level > 2 ? 'Medium' : 'Small',
                            damage: Math.floor(10 * scaleFactor * (isBoss ? 1.5 : 1)),
                            fireCooldown: isBoss ? 4.0 : Math.max(3.5 - level * 0.03, 2.5),
                            repairThreshold: 0.4
                        },
                        combatLog: [isBoss ? `√¢≈° Ô∏è¬è BOSS BATTLE: ${bossData.name} approaches!` : '‚öîÔ∏è Battle begins! Prepare for combat!']
                    }));
                }
            };

            const playerAttack = () => {
                // Prevent multi-click bug: check both state and ref
                if (gameState.battlePhase !== BATTLE_PHASES.FIGHTING || gameState.playerCooldown > 0 || actionInProgressRef.current) return;

                // Lock attack immediately with ref (synchronous)
                actionInProgressRef.current = true;

                setGameState(prev => ({ ...prev, playerCooldown: getPlayerCooldown() }));
                window.SoundSystem.cannonFire();

                if (playerShipRef.current) {
                    playerShipRef.current.classList.add('attacking');
                    setTimeout(() => {
                        if (playerShipRef.current) playerShipRef.current.classList.remove('attacking');
                    }, 600);
                }

                setTimeout(() => {
                    setGameState(prev => {
                        // Calculate damage inside setGameState to use current state
                        const damage = prev.player.damage + Math.random() * 10;
                        showDamageNumber('enemy', damage);
                        window.SoundSystem.shipHit();
                        addLog(`‚öîÔ∏è You fire your cannons! <span class="log-damage">-${Math.floor(damage)} damage</span>!`);

                        const newHealth = prev.enemy.health - damage;

                        if (newHealth <= 0) {
                            setTimeout(() => handleVictory(), 500);
                            return {
                                ...prev,
                                enemy: { ...prev.enemy, health: 0 }
                                // Keep battlePhase as FIGHTING until loot is revealed
                            };
                        }

                        return {
                            ...prev,
                            enemy: { ...prev.enemy, health: newHealth }
                        };
                    });

                    // Release attack lock after damage is applied
                    actionInProgressRef.current = false;
                }, 600);
            };

            // Enemy attacks are now handled by the real-time game loop

            const playerRepair = () => {
                // Prevent spam clicking: check both state and ref
                if (gameState.battlePhase !== BATTLE_PHASES.FIGHTING || gameState.playerCooldown > 0 || actionInProgressRef.current) return;
                if (gameState.player.health >= gameState.player.maxHealth) return;

                // Lock action immediately
                actionInProgressRef.current = true;

                window.SoundSystem.shipRepair();

                // Single setGameState call with all updates and fresh state calculations
                setGameState(prev => {
                    const healAmount = Math.min(
                        prev.player.repairAmount,
                        prev.player.maxHealth - prev.player.health
                    );

                    showDamageNumber('player', healAmount, true);
                    addLog(`üîß Repaired! <span class="log-heal">+${Math.floor(healAmount)}</span> HP!`);

                    return {
                        ...prev,
                        playerCooldown: getPlayerCooldown(),
                        player: {
                            ...prev.player,
                            health: Math.min(prev.player.health + healAmount, prev.player.maxHealth)
                        }
                    };
                });

                // Release action lock
                actionInProgressRef.current = false;
            };

            const handleVictory = () => {
                const lootItem = rollLoot(gameState.level, battlesSinceRare);
                setCurrentLoot(lootItem);
                
                if (lootItem.rarity === 'rare' || lootItem.rarity === 'legendary') {
                    setBattlesSinceRare(0);
                } else {
                    setBattlesSinceRare(b => b + 1);
                }
                
                setLootInventory(prev => [...prev, lootItem]);
                
                const currentEquipped = equipped[lootItem.type];
                if (!currentEquipped || lootItem.power > currentEquipped.power) {
                    setEquipped(prev => ({ ...prev, [lootItem.type]: lootItem }));
                }
                
                if (gameState.isBoss && gameState.bossData) {
                    const gemReward = gameState.level * 5 + 10;
                    setGems(g => g + gemReward);
                    setCurrentLoot(prev => ({ ...prev, gemReward, lootReward: 0 }));
                    window.SoundSystem.bossDefeated();
                    
                    const figurehead = gameState.bossData.figurehead;
                    if (!figureheads.find(f => f.id === figurehead.id)) {
                        setFigureheads(prev => [...prev, figurehead]);
                        setUnlockedFigurehead(figurehead);
                        setTimeout(() => {
                            setShowFigureheadUnlock(true);
                            window.SoundSystem.figureheadUnlock();
                            createConfetti();
                        }, 2000);
                    }
                } else {
                    const lootReward = gameState.level * 3 + 5;
                    setLoot(l => l + lootReward);
                    setCurrentLoot(prev => ({ ...prev, lootReward, gemReward: 0 }));
                    window.SoundSystem.victory();
                }
                
                setLootRevealed(false);
                setShowLootReveal(true);
                
                setTimeout(() => {
                    setLootRevealed(true);
                    if (lootItem.rarity === 'legendary') {
                        window.SoundSystem.lootRevealLegendary();
                        document.body.classList.add('screen-shake');
                        createConfetti();
                        setTimeout(() => document.body.classList.remove('screen-shake'), 500);
                    } else if (lootItem.rarity === 'rare') {
                        window.SoundSystem.lootRevealRare();
                    } else {
                        window.SoundSystem.lootRevealCommon();
                    }
                }, 1000);
            };

            const closeLootReveal = () => {
                setShowLootReveal(false);
                setGameState(prev => ({ ...prev, battlePhase: BATTLE_PHASES.VICTORY }));
                window.SoundSystem.buttonClick();
            };

            const nextLevel = () => {
                const newLevel = gameState.level + 1;
                window.SoundSystem.levelUp();
                startBattle(newLevel);
            };

            const restartBattle = () => {
                window.SoundSystem.buttonClick();
                
                // If boss fight lost, go back to start of the 10-level block
                if (gameState.isBoss) {
                    const blockStart = getBlockStart(gameState.level);
                    setTimeout(() => startBattle(blockStart), 100);
                } else {
                    setTimeout(() => startBattle(gameState.level), 100);
                }
            };

            const handleViewChange = (view) => {
                setCurrentView(view);
                window.SoundSystem.tabSwitch();
            };

            // ============ COMPONENTS ============
            
            const GemIcon = ({ size = "w-8 h-8" }) => (
                <div className={`${size} relative inline-flex items-center justify-center`}>
                    <span className="text-2xl">üíé</span>
                </div>
            );

            const LootIcon = ({ size = "w-8 h-8" }) => (
                <div className={`${size} relative inline-flex items-center justify-center`}>
                    <span className="text-2xl">ü™ô</span>
                </div>
            );
            
            const Avatar = () => {
                const getSkinEmoji = () => {
                    const skins = { default: 'üòä', cool: 'üòé', happy: 'üòÑ', star: '‚≠ê' };
                    return skins[avatar.skin] || 'üòä';
                };
                
                const getOutfitColor = () => {
                    const outfits = { casual: 'bg-blue-400', superhero: 'bg-red-500', wizard: 'bg-purple-600', ninja: 'bg-gray-800' };
                    return outfits[avatar.outfit] || 'bg-blue-400';
                };
                
                const getAccessoryEmoji = () => {
                    const accessories = { none: '', crown: 'üëë', sunglasses: 'üï∂Ô∏è¬è', hat: 'üé©' };
                    return accessories[avatar.accessory] || '';
                };
                
                return (
                    <div className="relative float">
                        <div className={`w-32 h-40 ${getOutfitColor()} rounded-3xl shadow-lg relative`}>
                            <div className="absolute -top-8 left-1/2 transform -translate-x-1/2 text-6xl">{getSkinEmoji()}</div>
                            {avatar.accessory !== 'none' && (
                                <div className="absolute -top-12 left-1/2 transform -translate-x-1/2 text-4xl">{getAccessoryEmoji()}</div>
                            )}
                        </div>
                    </div>
                );
            };

            const PirateShipSVG = ({ isPlayer, size }) => {
                const sizeClass = `size-${size}`;
                
                return (
                    <svg className={`ship-visual ${sizeClass}`} viewBox="0 0 300 250" xmlns="http://www.w3.org/2000/svg">
                        <ellipse cx="150" cy="195" rx="80" ry="8" fill={isPlayer ? "rgba(74, 124, 158, 0.3)" : "rgba(139, 0, 0, 0.2)"}/>
                        <path d="M50 180 L30 150 Q25 130 30 120 L40 90 L260 90 L270 120 Q275 130 270 150 L250 180 Z" fill="rgba(0,0,0,0.3)" transform="translate(3, 5)"/>
                        <path d="M50 180 L30 150 Q25 130 30 120 L40 90 L260 90 L270 120 Q275 130 270 150 L250 180 Z" fill={isPlayer ? "#3d2817" : "#1a1a1a"} stroke={isPlayer ? "#2a1810" : "#000"} strokeWidth="3"/>
                        <path d="M45 100 Q150 102 255 100" stroke={isPlayer ? "#2a1810" : "#000"} strokeWidth="1" opacity="0.5" fill="none"/>
                        <path d="M42 110 Q150 112 258 110" stroke={isPlayer ? "#2a1810" : "#000"} strokeWidth="1" opacity="0.5" fill="none"/>
                        <path d="M40 120 Q150 122 260 120" stroke={isPlayer ? "#2a1810" : "#000"} strokeWidth="1" opacity="0.5" fill="none"/>
                        <path d="M50 180 L35 155 Q32 140 35 130 L42 100 L80 100 L70 130 L60 160 Z" fill={isPlayer ? "#6b4423" : "#2d2d2d"} opacity="0.6"/>
                        <rect x="40" y="85" width="220" height="12" fill={isPlayer ? "#6b4423" : "#2d2d2d"} stroke={isPlayer ? "#3d2817" : "#1a1a1a"} strokeWidth="2" rx="2"/>
                        <rect x="110" y="20" width="8" height="75" fill={isPlayer ? "#6b4423" : "#2d2d2d"} stroke={isPlayer ? "#3d2817" : "#1a1a1a"} strokeWidth="2"/>
                        <rect x="180" y="30" width="8" height="65" fill={isPlayer ? "#6b4423" : "#2d2d2d"} stroke={isPlayer ? "#3d2817" : "#1a1a1a"} strokeWidth="2"/>
                        <path className="sail" d="M120 35 L180 35 Q185 60 180 80 L120 80 Q115 60 120 35 Z" fill={isPlayer ? "#f5f5dc" : "#4a0000"} stroke={isPlayer ? "#8b7355" : "#2d0000"} strokeWidth="2"/>
                        <path className="sail" d="M188 45 L230 45 Q233 60 230 75 L188 75 Q185 60 188 45 Z" fill={isPlayer ? "#f5f5dc" : "#4a0000"} stroke={isPlayer ? "#8b7355" : "#2d0000"} strokeWidth="2"/>
                        <rect x="108" y="20" width="12" height="8" fill={isPlayer ? "#3d2817" : "#1a1a1a"} stroke={isPlayer ? "#2a1810" : "#000"} strokeWidth="1" rx="1"/>
                        <g className="flag">
                            <line x1="115" y1="20" x2="115" y2="5" stroke={isPlayer ? "#2a1810" : "#000"} strokeWidth="2"/>
                            <path d="M115 5 L140 8 Q138 12 140 16 L115 13 Z" fill={isPlayer ? "#1a1a1a" : "#8b0000"}/>
                            <text x="120" y="14" fontSize="8" fill="#fff" fontWeight="bold">‚ò†</text>
                        </g>
                        <line x1="45" y1="90" x2="255" y2="90" stroke={isPlayer ? "#3d2817" : "#1a1a1a"} strokeWidth="3"/>
                        <circle cx="200" cy="110" r="7" fill={isPlayer ? "#ffd700" : "#ff4500"} opacity="0.8" stroke={isPlayer ? "#8b7355" : "#8b0000"} strokeWidth="1.5"/>
                        <circle cx="220" cy="115" r="6" fill={isPlayer ? "#ffd700" : "#ff4500"} opacity="0.8" stroke={isPlayer ? "#8b7355" : "#8b0000"} strokeWidth="1.5"/>
                        <line x1="270" y1="120" x2="290" y2="110" stroke={isPlayer ? "#6b4423" : "#2d2d2d"} strokeWidth="5" strokeLinecap="round"/>
                    </svg>
                );
            };
            
            const currentShipData = SHIP_PROGRESSION.find(s => s.id === currentShip);
            const nextShip = SHIP_PROGRESSION.find(s => !ownedShips.includes(s.id));
            const progressToNext = nextShip ? (gems / nextShip.cost) * 100 : 100;

            return (
                <div className={`min-h-screen p-4 ${currentView === 'battle' ? 'battle-view' : currentView === 'collection' ? 'collection-view' : 'chore-view'}`}>
                    {/* Sound Toggle Button */}
                    <button 
                        onClick={toggleSound}
                        className={`sound-toggle ${!soundEnabled ? 'muted' : ''}`}
                        title={soundEnabled ? 'Mute sounds' : 'Enable sounds'}
                    >
                        {soundEnabled ? 'üîä' : 'üîá'}
                    </button>

                    {/* Save Error Toast */}
                    {saveError && (
                        <div className="save-error-toast">
                            ‚ö†Ô∏è {saveError}
                        </div>
                    )}

                    {currentView === 'battle' && (
                        <div className="ocean-waves">
                            <div className="wave"></div>
                            <div className="wave"></div>
                            <div className="wave"></div>
                        </div>
                    )}
                    
                    <div className="max-w-6xl mx-auto relative z-10">
                        {/* Header */}
                        <div className="bg-white rounded-3xl shadow-2xl p-6 mb-6">
                            <div className="flex justify-between items-center flex-wrap gap-4">
                                <h1 className="text-4xl font-bold text-purple-600">üåü Chore Quest</h1>
                                <div className="flex items-center gap-4">
                                    {streak > 0 && (
                                        <div className="flex items-center gap-1 bg-orange-100 px-3 py-2 rounded-full">
                                            <span className="text-2xl streak-fire">üî•</span>
                                            <span className="text-xl font-bold text-orange-600">{streak}</span>
                                        </div>
                                    )}
                                    <div className={`flex items-center gap-2 bg-purple-100 px-4 py-2 rounded-full ${celebration ? 'bounce' : ''}`}>
                                        <GemIcon size="w-8 h-8" />
                                        <span className="text-2xl font-bold text-purple-700">{gems}</span>
                                    </div>
                                    <div className="flex items-center gap-2 bg-yellow-100 px-4 py-2 rounded-full">
                                        <LootIcon size="w-8 h-8" />
                                        <span className="text-2xl font-bold text-yellow-700">{loot}</span>
                                        <span className="text-xs text-yellow-600">loot</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {/* Navigation */}
                        <div className="flex gap-2 mb-6 overflow-x-auto">
                            {['tasks', 'avatar', 'store', 'battle', 'collection'].map(view => (
                                <button
                                    key={view}
                                    onClick={() => handleViewChange(view)}
                                    className={`flex-1 min-w-[100px] py-3 rounded-2xl font-bold text-lg transition-all ${
                                        currentView === view
                                            ? 'bg-pink-500 text-white shadow-lg scale-105'
                                            : 'bg-white text-gray-600 hover:bg-pink-100'
                                    }`}
                                >
                                    {view === 'tasks' && 'üìù'}
                                    {view === 'avatar' && 'üë§'}
                                    {view === 'store' && 'üè™'}
                                    {view === 'battle' && '‚öîÔ∏è'}
                                    {view === 'collection' && 'üéí'}
                                    <span className="ml-1 capitalize">{view}</span>
                                </button>
                            ))}
                        </div>
                        
                        {/* Tasks View */}
                        {currentView === 'tasks' && (
                            <div className="bg-white rounded-3xl shadow-2xl p-8">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-3xl font-bold text-purple-600">Today's Chores</h2>
                                    <button
                                        onClick={openChoreManagement}
                                        className="px-4 py-2 bg-purple-100 text-purple-700 rounded-xl font-semibold hover:bg-purple-200 transition-all flex items-center gap-2"
                                    >
                                        ‚öôÔ∏è Parent Settings
                                    </button>
                                </div>

                                <div className="space-y-4">
                                    {tasks.map(task => {
                                        const pendingCount = pendingApproval.filter(p => p.id === task.id).length;
                                        const canClick = task.repeatType === 'multiple' || !task.completed;
                                        return (
                                            <div
                                                key={task.id}
                                                onClick={() => canClick && toggleTask(task.id)}
                                                className={`p-6 rounded-2xl cursor-pointer transition-all ${
                                                    task.completed && task.repeatType !== 'multiple'
                                                        ? task.pendingApproval
                                                            ? 'bg-yellow-50 border-4 border-yellow-400'
                                                            : 'bg-green-100 border-4 border-green-400'
                                                        : 'bg-gradient-to-r from-purple-100 to-pink-100 border-4 border-purple-300 hover:scale-105 shine'
                                                }`}
                                            >
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center gap-4">
                                                        <span className="text-5xl">{task.icon}</span>
                                                        <div>
                                                            <h3 className="text-2xl font-bold text-gray-800">{task.name}</h3>
                                                            <div className="flex items-center gap-2 mt-1 flex-wrap">
                                                                <GemIcon size="w-6 h-6" />
                                                                <span className="text-lg font-semibold text-purple-700">
                                                                    +{task.points}{streak > 0 && <span className="text-orange-500"> +{Math.floor(streak/5)} streak</span>}
                                                                </span>
                                                                {task.repeatType === 'multiple' && (
                                                                    <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">üîÅ Multi</span>
                                                                )}
                                                                {task.repeatType === 'once' && (
                                                                    <span className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">üî≤ Once</span>
                                                                )}
                                                                {pendingCount > 0 && (
                                                                    <span className="approval-badge pending">‚è≥ {pendingCount} pending</span>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className={`w-12 h-12 rounded-full border-4 flex items-center justify-center ${
                                                        task.completed && task.repeatType !== 'multiple'
                                                            ? task.pendingApproval ? 'bg-yellow-400 border-yellow-500' : 'bg-green-500 border-green-600'
                                                            : pendingCount > 0 ? 'bg-yellow-400 border-yellow-500'
                                                            : 'bg-white border-purple-300'
                                                    }`}>
                                                        {task.completed && task.repeatType !== 'multiple' && task.pendingApproval && <span className="text-2xl">‚è≥</span>}
                                                        {task.completed && task.repeatType !== 'multiple' && !task.pendingApproval && <span className="text-3xl text-white">‚úî</span>}
                                                        {task.repeatType === 'multiple' && pendingCount > 0 && <span className="text-lg font-bold">{pendingCount}</span>}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>

                                {hasPendingChores && (
                                    <button
                                        onClick={openParentReview}
                                        className="request-approval-btn"
                                    >
                                        üë®‚Äçüë©‚Äçüëß Ask Parent to Review ({pendingApproval.length} chore{pendingApproval.length !== 1 ? 's' : ''})
                                    </button>
                                )}

                                {tasks.filter(t => t.repeatType !== 'multiple').every(task => task.completed && !task.pendingApproval) && tasks.filter(t => t.repeatType !== 'multiple').length > 0 && pendingApproval.length === 0 && (
                                    <div className="mt-8 p-6 bg-gradient-to-r from-yellow-200 to-orange-200 rounded-2xl text-center">
                                        <p className="text-3xl font-bold text-orange-700">üéâ All chores complete! Amazing work! üéâ</p>
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {/* Avatar View */}
                        {currentView === 'avatar' && (
                            <div className="bg-white rounded-3xl shadow-2xl p-8">
                                <h2 className="text-3xl font-bold text-purple-600 mb-6">My Avatar</h2>
                                <div className="flex flex-col items-center mb-8">
                                    <Avatar />
                                </div>
                                
                                <div className="space-y-6">
                                    {['skin', 'outfit', 'accessory'].map(type => (
                                        <div key={type}>
                                            <h3 className="text-2xl font-bold text-gray-700 mb-3 capitalize">{type}s</h3>
                                            <div className="grid grid-cols-4 gap-3">
                                                {STORE_ITEMS.filter(item => item.type === type && inventory.includes(item.id)).map(item => (
                                                    <button
                                                        key={item.id}
                                                        onClick={() => equipItem(item.id, type)}
                                                        className={`p-4 rounded-xl text-4xl transition-all ${
                                                            avatar[type] === item.id
                                                                ? 'bg-purple-500 scale-110'
                                                                : 'bg-purple-100 hover:bg-purple-200'
                                                        }`}
                                                    >
                                                        {item.emoji}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {/* Store View */}
                        {currentView === 'store' && (
                            <div className="bg-white rounded-3xl shadow-2xl p-8">
                                <h2 className="text-3xl font-bold text-purple-600 mb-6">üíé Gem Store</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {STORE_ITEMS.map(item => {
                                        const owned = inventory.includes(item.id);
                                        const canAfford = gems >= item.price;
                                        
                                        return (
                                            <div
                                                key={item.id}
                                                className={`p-6 rounded-2xl border-4 transition-all ${
                                                    owned ? 'bg-green-50 border-green-400'
                                                    : canAfford ? 'bg-gradient-to-br from-purple-50 to-pink-50 border-purple-300 hover:scale-105 cursor-pointer'
                                                    : 'bg-gray-100 border-gray-300 opacity-60'
                                                }`}
                                                onClick={() => !owned && canAfford && buyItem(item)}
                                            >
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center gap-4">
                                                        <span className="text-6xl">{item.emoji}</span>
                                                        <div>
                                                            <h3 className="text-xl font-bold text-gray-800">{item.name}</h3>
                                                            <div className="flex items-center gap-2 mt-2">
                                                                <GemIcon size="w-6 h-6" />
                                                                <span className="text-lg font-semibold text-purple-700">{item.price}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {owned ? <span className="text-4xl">√¢≈ì‚Äú</span>
                                                    : canAfford ? <button className="px-6 py-3 bg-purple-500 text-white rounded-xl font-bold hover:bg-purple-600">Buy</button>
                                                    : <span className="text-2xl">üîí</span>}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* Collection View */}
                        {currentView === 'collection' && (
                            <div className="space-y-6">
                                {/* Ships */}
                                <div className="bg-gradient-to-br from-blue-900 to-purple-900 rounded-3xl p-6 border-4 border-blue-500">
                                    <h2 className="text-3xl font-bold text-white mb-6">üö¢ Ships</h2>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        {SHIP_PROGRESSION.map(ship => {
                                            const owned = ownedShips.includes(ship.id);
                                            const isSelected = currentShip === ship.id;
                                            const canAfford = gems >= ship.cost;
                                            
                                            return (
                                                <div
                                                    key={ship.id}
                                                    onClick={() => owned ? selectShip(ship.id) : canAfford && buyShip(ship)}
                                                    className={`p-4 rounded-xl text-center cursor-pointer transition-all ${
                                                        isSelected ? 'bg-yellow-500 scale-105 ring-4 ring-yellow-300'
                                                        : owned ? 'bg-blue-700 hover:bg-blue-600'
                                                        : canAfford ? 'bg-gray-700 hover:bg-gray-600'
                                                        : 'bg-gray-800 opacity-50'
                                                    }`}
                                                >
                                                    <div className="text-4xl mb-2">{owned ? ship.emoji : '‚ùî'}</div>
                                                    <div className="text-white font-bold text-sm">{ship.name}</div>
                                                    {!owned && (
                                                        <div className="flex items-center justify-center gap-1 mt-2">
                                                            <span className="text-lg">üíé</span>
                                                            <span className="text-yellow-300 font-bold">{ship.cost}</span>
                                                        </div>
                                                    )}
                                                    {isSelected && <div className="text-xs mt-1 text-yellow-200">EQUIPPED</div>}
                                                </div>
                                            );
                                        })}
                                    </div>
                                    {nextShip && (
                                        <div className="mt-4">
                                            <div className="text-white text-sm mb-2">Progress to {nextShip.name}: {gems}/{nextShip.cost} üíé</div>
                                            <div className="progress-bar-container">
                                                <div className="progress-bar-fill" style={{width: `${Math.min(progressToNext, 100)}%`}}></div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Figureheads section hidden for now */}
                                {/* Equipment and Loot sections hidden for now */}
                            </div>
                        )}

                        {/* Battle View */}
                        {currentView === 'battle' && (
                            <div>
                                <h1 style={{fontFamily: 'Cinzel'}} className="text-5xl font-bold text-center mb-4 text-yellow-400">
                                    ‚öîÔ∏è BATTLE ‚öîÔ∏è
                                </h1>
                                <div className="text-center text-xl mb-6 text-blue-200">
                                    Level {gameState.level}
                                    {gameState.level % 10 === 0 && BOSS_BATTLES[gameState.level] && (
                                        <span className="ml-2 text-red-400">üî• BOSS LEVEL!</span>
                                    )}
                                </div>

                                {/* Inline Victory State */}
                                {gameState.battlePhase === BATTLE_PHASES.VICTORY ? (
                                    <div className="bg-gradient-to-br from-yellow-600 to-orange-600 rounded-3xl p-12 text-center border-8 border-yellow-400 shadow-2xl">
                                        <h2 style={{fontFamily: 'Cinzel'}} className="text-6xl font-bold text-white mb-4">
                                            üèÜ VICTORY! üèÜ
                                        </h2>
                                        <p className="text-2xl text-white mb-8">Level {gameState.level} Complete!</p>
                                        <button
                                            onClick={nextLevel}
                                            style={{fontFamily: 'Cinzel'}}
                                            className="px-12 py-4 bg-white text-orange-600 rounded-xl font-bold text-2xl hover:scale-105 transition-transform shadow-xl"
                                        >
                                            NEXT LEVEL ‚öîÔ∏è
                                        </button>
                                    </div>
                                ) : gameState.battlePhase === BATTLE_PHASES.DEFEAT ? (
                                    <div className="bg-gradient-to-br from-red-900 to-black rounded-3xl p-12 text-center border-8 border-red-700 shadow-2xl">
                                        <h2 style={{fontFamily: 'Cinzel'}} className="text-6xl font-bold text-red-500 mb-4">
                                            üíÄ DEFEATED üíÄ
                                        </h2>
                                        {gameState.isBoss ? (
                                            <>
                                                <p className="text-xl text-white mb-4">The boss was too strong!</p>
                                                <p className="text-lg text-gray-300 mb-8">
                                                    Back to Level {getBlockStart(gameState.level)} to train.
                                                </p>
                                            </>
                                        ) : (
                                            <p className="text-xl text-gray-300 mb-8">Your ship has been sunk!</p>
                                        )}
                                        <button
                                            onClick={restartBattle}
                                            style={{fontFamily: 'Cinzel'}}
                                            className="px-12 py-4 bg-red-600 text-white rounded-xl font-bold text-2xl hover:scale-105 transition-transform shadow-xl"
                                        >
                                            {gameState.isBoss ? 'BACK TO TRAINING ‚öîÔ∏è' : 'TRY AGAIN ‚öîÔ∏è'}
                                        </button>
                                    </div>
                                ) : gameState.battlePhase === BATTLE_PHASES.IDLE ? (
                                    <div className="space-y-6">
                                        {/* Ship Preview & Start Battle */}
                                        <div className="bg-opacity-40 bg-blue-900 backdrop-blur rounded-3xl p-8 text-center">
                                            <div className="text-6xl mb-4">{currentShipData?.emoji || 'üö£'}</div>
                                            <div className="text-2xl text-white mb-4">{currentShipData?.name || 'Rusty Raft'}</div>
                                            <div className="text-yellow-400 mb-6">‚ö° Power: {getTotalPower()}</div>
                                            <button
                                                onClick={() => startBattle()}
                                                style={{fontFamily: 'Cinzel'}}
                                                className="px-12 py-6 bg-gradient-to-r from-yellow-600 to-orange-600 text-white rounded-2xl font-bold text-3xl hover:scale-105 transition-transform shadow-2xl"
                                            >
                                                üè¥‚Äç‚ò†Ô∏è START BATTLE üè¥‚Äç‚ò†Ô∏è
                                            </button>
                                        </div>

                                        {/* Ship Upgrades Section */}
                                        <div className="bg-opacity-40 bg-gray-900 backdrop-blur rounded-3xl p-6 border-4 border-yellow-600">
                                            <h3 className="text-2xl font-bold text-yellow-400 mb-4 text-center">üîß Ship Upgrades</h3>
                                            <div className="text-center text-yellow-300 mb-4">
                                                ü™ô Loot Available: <span className="font-bold text-2xl">{loot}</span>
                                            </div>

                                            {/* Stats Summary */}
                                            <div className="stats-summary mb-4">
                                                <div className="stats-grid">
                                                    <div className="stat-item">
                                                        <span className="stat-label">üí• Damage</span>
                                                        <span className="stat-value">{getComputedStats().damage}</span>
                                                    </div>
                                                    <div className="stat-item">
                                                        <span className="stat-label">‚ö° Cooldown</span>
                                                        <span className="stat-value">-{getComputedStats().cooldownReduction}%</span>
                                                    </div>
                                                    <div className="stat-item">
                                                        <span className="stat-label">‚ù§Ô∏è Max HP</span>
                                                        <span className="stat-value">{getComputedStats().maxHealth}</span>
                                                    </div>
                                                    <div className="stat-item">
                                                        <span className="stat-label">üîß Repair</span>
                                                        <span className="stat-value">{getComputedStats().repairAmount}</span>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Upgrade Cards */}
                                            <div className="upgrades-container">
                                                {[
                                                    { key: 'firepower', name: 'üí• Firepower', desc: 'Damage per shot', unit: ' dmg' },
                                                    { key: 'crew', name: '‚ö° Crew', desc: 'Cooldown reduction', unit: '%' },
                                                    { key: 'hull', name: 'üõ°Ô∏è Hull', desc: 'Max health', unit: ' HP' },
                                                    { key: 'repair', name: 'üîß Repair', desc: 'Health per repair', unit: ' HP' }
                                                ].map(upgrade => {
                                                    const stat = shipStats[upgrade.key];
                                                    const currentValue = stat.base + (stat.level - 1) * stat.perLevel;
                                                    const nextValue = currentValue + stat.perLevel;
                                                    const cost = getUpgradeCost(stat.level);
                                                    const canAfford = loot >= cost;

                                                    return (
                                                        <div key={upgrade.key} className="upgrade-card">
                                                            <div className="upgrade-header">
                                                                <span className="upgrade-name">{upgrade.name}</span>
                                                                <span className="upgrade-level">Lv. {stat.level}</span>
                                                            </div>
                                                            <div className="upgrade-description">{upgrade.desc}</div>
                                                            <div className="upgrade-stats">
                                                                <span className="stat-current">{currentValue}{upgrade.unit}</span>
                                                                <span className="stat-arrow">‚Üí</span>
                                                                <span className="stat-next">{nextValue}{upgrade.unit}</span>
                                                            </div>
                                                            <button
                                                                className="upgrade-btn"
                                                                onClick={() => purchaseUpgrade(upgrade.key)}
                                                                disabled={!canAfford}
                                                            >
                                                                <span>ü™ô {cost}</span>
                                                                <span>UPGRADE</span>
                                                            </button>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <>
                                        {/* Battle Arena */}
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                            {/* Player Ship */}
                                            <div className="bg-opacity-40 bg-blue-900 backdrop-blur rounded-3xl p-6 border-4 border-blue-500 shadow-2xl">
                                                <h3 style={{fontFamily: 'Cinzel'}} className="text-2xl font-bold text-yellow-400 text-center mb-4">
                                                    {currentShipData?.name || 'Your Ship'}
                                                </h3>
                                                <div ref={playerShipRef} className="ship player-ship flex justify-center mb-4">
                                                    <PirateShipSVG isPlayer={true} size={gameState.player.size} />
                                                </div>
                                                <div className="space-y-2 text-white">
                                                    <div className="flex justify-between"><span>√¢≈°‚ÄùÔ∏è¬è Cannons:</span><span className="font-bold text-yellow-400">{gameState.player.cannons}</span></div>
                                                    <div className="flex justify-between"><span>üí• Crew:</span><span className="font-bold text-yellow-400">{gameState.player.crew}</span></div>
                                                    <div className="health-bar mt-4">
                                                        <div className="health-fill" style={{width: `${(gameState.player.health / gameState.player.maxHealth) * 100}%`}}></div>
                                                        <div className="health-text">{Math.floor(gameState.player.health)} / {gameState.player.maxHealth}</div>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Enemy Ship */}
                                            <div className={`bg-opacity-40 ${gameState.isBoss ? 'bg-purple-900 border-purple-500' : 'bg-red-900 border-red-500'} backdrop-blur rounded-3xl p-6 border-4 shadow-2xl`}>
                                                <h3 style={{fontFamily: 'Cinzel'}} className="text-2xl font-bold text-yellow-400 text-center mb-4">
                                                    {gameState.isBoss && gameState.bossData ? (
                                                        <span className="flex items-center justify-center gap-2">
                                                            <span className="text-3xl">{gameState.bossData.emoji}</span>
                                                            {gameState.bossData.name}
                                                        </span>
                                                    ) : (
                                                        `Level ${gameState.level} Enemy`
                                                    )}
                                                </h3>
                                                <div ref={enemyShipRef} className="ship enemy-ship flex justify-center mb-4">
                                                    <PirateShipSVG isPlayer={false} size={gameState.enemy.size} />
                                                </div>
                                                <div className="space-y-2 text-white">
                                                    <div className="flex justify-between"><span>√¢≈°‚ÄùÔ∏è¬è Cannons:</span><span className="font-bold text-yellow-400">{gameState.enemy.cannons}</span></div>
                                                    <div className="flex justify-between"><span>üí• Crew:</span><span className="font-bold text-yellow-400">{gameState.enemy.crew}</span></div>
                                                    <div className="health-bar mt-4">
                                                        <div className="health-fill" style={{width: `${(gameState.enemy.health / gameState.enemy.maxHealth) * 100}%`}}></div>
                                                        <div className="health-text">{Math.floor(gameState.enemy.health)} / {Math.floor(gameState.enemy.maxHealth)}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Auto Battle Toggle */}
                                        <div className="auto-battle-container">
                                            <div
                                                className="auto-battle-toggle"
                                                onClick={() => setAutoBattle(!autoBattle)}
                                            >
                                                <span className="text-white font-semibold">Auto Battle</span>
                                                <div className={`toggle-switch ${autoBattle ? 'active' : ''}`}></div>
                                            </div>
                                        </div>

                                        {/* Enemy Attack Warning */}
                                        <div className={`enemy-action-bar ${gameState.enemyCooldown <= 0.5 ? 'enemy-ready' : ''}`}>
                                            <div className="enemy-action-label">
                                                {gameState.enemyCooldown <= 0.5 ? (
                                                    <span className="enemy-warning">‚ö†Ô∏è INCOMING ATTACK!</span>
                                                ) : (
                                                    <span>üè¥‚Äç‚ò†Ô∏è Enemy reloading... {gameState.enemyCooldown.toFixed(1)}s</span>
                                                )}
                                            </div>
                                            <div className="enemy-cooldown-bar">
                                                <div
                                                    className={`enemy-cooldown-fill ${gameState.enemyCooldown <= 0.5 ? 'enemy-fill-ready' : ''}`}
                                                    style={{width: `${gameState.enemy.fireCooldown > 0 ? ((1 - gameState.enemyCooldown / gameState.enemy.fireCooldown) * 100) : 0}%`}}
                                                ></div>
                                            </div>
                                        </div>

                                        {/* Cooldown Progress Bar */}
                                        <div className="mb-4 px-4">
                                            <div className="cooldown-progress-container">
                                                <div
                                                    className={`cooldown-progress-bar ${gameState.playerCooldown <= 0 ? 'ready' : ''}`}
                                                    style={{width: `${gameState.playerCooldown > 0 ? ((1 - gameState.playerCooldown / getPlayerCooldown()) * 100) : 100}%`}}
                                                ></div>
                                                <span className="cooldown-progress-label">
                                                    {gameState.playerCooldown > 0 ? `‚è≥ ${gameState.playerCooldown.toFixed(1)}s` : '‚ö° READY!'}
                                                </span>
                                            </div>
                                        </div>

                                        {/* Combat Actions with Cooldowns */}
                                        <div className="flex gap-4 justify-center mb-6 flex-wrap">
                                            <button
                                                onClick={playerAttack}
                                                disabled={gameState.playerCooldown > 0}
                                                style={{fontFamily: 'Cinzel'}}
                                                className={`battle-action-btn fire ${gameState.playerCooldown <= 0 ? 'ready' : ''}`}
                                            >
                                                <div
                                                    className="cooldown-overlay"
                                                    style={{height: `${(gameState.playerCooldown / getPlayerCooldown()) * 100}%`}}
                                                ></div>
                                                <span className="btn-label">üí£ FIRE!</span>
                                                <span className="cooldown-text">
                                                    {gameState.playerCooldown > 0 ? `${gameState.playerCooldown.toFixed(1)}s` : 'Ready!'}
                                                </span>
                                            </button>
                                            <button
                                                onClick={playerRepair}
                                                disabled={gameState.playerCooldown > 0 || gameState.player.health >= gameState.player.maxHealth}
                                                style={{fontFamily: 'Cinzel'}}
                                                className={`battle-action-btn repair ${gameState.playerCooldown <= 0 && gameState.player.health < gameState.player.maxHealth ? 'ready' : ''}`}
                                            >
                                                <div
                                                    className="cooldown-overlay"
                                                    style={{height: `${(gameState.playerCooldown / getPlayerCooldown()) * 100}%`}}
                                                ></div>
                                                <span className="btn-label">üîß REPAIR</span>
                                                <span className="cooldown-text">
                                                    {gameState.playerCooldown > 0 ? `${gameState.playerCooldown.toFixed(1)}s` : 'Ready!'}
                                                </span>
                                            </button>
                                        </div>

                                        {/* Combat Log */}
                                        <div className="combat-log text-white">
                                            {gameState.combatLog.map((log, idx) => (
                                                <div key={idx} className="log-entry">{renderLogEntry(log)}</div>
                                            ))}
                                        </div>
                                    </>
                                )}
                            </div>
                        )}
                    </div>

                    {/* Loot Reveal Modal - Battle Tab Only */}
                    {currentView === 'battle' && showLootReveal && currentLoot && (
                        <div className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50">
                            <div className="text-center">
                                <h2 style={{fontFamily: 'Cinzel'}} className="text-4xl font-bold text-white mb-8">LOOT DROP!</h2>
                                
                                <div className={`loot-card w-64 h-80 mx-auto mb-8 ${lootRevealed ? 'flipped' : ''}`}>
                                    <div className="loot-card-inner relative w-full h-full">
                                        <div className="loot-card-front bg-gradient-to-br from-gray-700 to-gray-900 rounded-2xl flex items-center justify-center border-4 border-yellow-500">
                                            <span className="text-8xl">‚ùî</span>
                                        </div>
                                        <div className={`loot-card-back rounded-2xl flex flex-col items-center justify-center p-6 border-4 ${
                                            currentLoot.rarity === 'legendary' ? 'bg-gradient-to-br from-purple-600 to-purple-900 border-purple-400 legendary-glow'
                                            : currentLoot.rarity === 'rare' ? 'bg-gradient-to-br from-blue-600 to-blue-900 border-blue-400 rare-glow'
                                            : 'bg-gradient-to-br from-gray-600 to-gray-800 border-gray-400'
                                        }`}>
                                            <span className="text-6xl mb-4">{currentLoot.emoji}</span>
                                            <span className={`text-sm font-bold uppercase mb-2 ${
                                                currentLoot.rarity === 'legendary' ? 'text-purple-300'
                                                : currentLoot.rarity === 'rare' ? 'text-blue-300'
                                                : 'text-gray-300'
                                            }`}>{currentLoot.rarity}</span>
                                            <span className="text-xl font-bold text-white mb-2">{currentLoot.name}</span>
                                            <span className="text-yellow-400 font-bold">+{currentLoot.power} Power</span>
                                            <span className="text-gray-300 text-sm mt-2 capitalize">{currentLoot.type}</span>
                                        </div>
                                    </div>
                                </div>

                                {lootRevealed && (
                                    <div className="space-y-4">
                                        {currentLoot.gemReward > 0 && (
                                            <div className="text-2xl text-purple-300">+{currentLoot.gemReward} üíé Gems!</div>
                                        )}
                                        {currentLoot.lootReward > 0 && (
                                            <div className="text-2xl text-yellow-300">+{currentLoot.lootReward} ü™ô Loot!</div>
                                        )}
                                        <button
                                            onClick={closeLootReveal}
                                            style={{fontFamily: 'Cinzel'}}
                                            className="mt-4 px-8 py-4 bg-gradient-to-r from-yellow-600 to-orange-600 text-white rounded-xl font-bold text-xl hover:scale-105 transition-transform"
                                        >
                                            CONTINUE
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}



                    {/* Boss Intro - Battle Tab Only */}
                    {currentView === 'battle' && showBossIntro && gameState.bossData && (
                        <div className="fixed inset-0 bg-black bg-opacity-95 flex items-center justify-center z-50">
                            <div className="text-center boss-entrance">
                                <div className="text-9xl mb-8 pulse-glow" style={{color: '#ff4444'}}>{gameState.bossData.emoji}</div>
                                <h2 style={{fontFamily: 'Cinzel'}} className="text-5xl font-bold text-red-500 mb-4">
                                    √¢≈° Ô∏è¬è BOSS BATTLE √¢≈° Ô∏è¬è
                                </h2>
                                <p className="text-3xl text-white">{gameState.bossData.name}</p>
                            </div>
                        </div>
                    )}

                    {/* Figurehead Unlock - Battle Tab Only */}
                    {currentView === 'battle' && showFigureheadUnlock && unlockedFigurehead && (
                        <div className="fixed inset-0 bg-black bg-opacity-95 flex items-center justify-center z-50">
                            <div className="bg-gradient-to-br from-purple-800 to-pink-900 rounded-3xl p-12 text-center max-w-lg border-8 border-purple-400 shadow-2xl unlock-burst">
                                <h2 style={{fontFamily: 'Cinzel'}} className="text-4xl font-bold text-white mb-4">
                                    üèÜ FIGUREHEAD UNLOCKED! üèÜ
                                </h2>
                                <div className="text-8xl mb-4">{unlockedFigurehead.emoji}</div>
                                <p className="text-2xl text-purple-200 font-bold mb-2">{unlockedFigurehead.name}</p>
                                <p className="text-lg text-gray-300 mb-8">{unlockedFigurehead.description}</p>
                                <button
                                    onClick={() => setShowFigureheadUnlock(false)}
                                    className="px-8 py-3 bg-purple-500 text-white rounded-xl font-bold text-xl hover:bg-purple-400"
                                >
                                    AWESOME!
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Ship Unlock - Battle Tab Only */}
                    {currentView === 'battle' && showShipUnlock && unlockedShip && (
                        <div className="fixed inset-0 bg-black bg-opacity-95 flex items-center justify-center z-50">
                            <div className="bg-gradient-to-br from-blue-800 to-cyan-900 rounded-3xl p-12 text-center max-w-lg border-8 border-blue-400 shadow-2xl unlock-burst">
                                <h2 style={{fontFamily: 'Cinzel'}} className="text-4xl font-bold text-white mb-4">
                                    üö¢ NEW SHIP! üö¢
                                </h2>
                                <div className="text-8xl mb-4">{unlockedShip.emoji}</div>
                                <p className="text-2xl text-blue-200 font-bold mb-2">{unlockedShip.name}</p>
                                <p className="text-lg text-gray-300 mb-8">{unlockedShip.description}</p>
                                <button
                                    onClick={() => setShowShipUnlock(false)}
                                    className="px-8 py-3 bg-blue-500 text-white rounded-xl font-bold text-xl hover:bg-blue-400"
                                >
                                    SET SAIL!
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Password Setup Modal */}
                    {showPasswordSetup && (
                        <div className="modal-overlay" onClick={() => { setShowPasswordSetup(false); setPendingPasswordAction(null); clearPatternInput(); }}>
                            <div className="modal-content" onClick={e => e.stopPropagation()}>
                                <h2 className="text-2xl font-bold text-purple-600 text-center mb-2">üîê Create Parent Pattern</h2>
                                <p className="text-gray-600 text-center mb-4">
                                    Draw a pattern connecting at least 4 dots
                                </p>

                                <div
                                    className="pattern-lock-container"
                                    ref={patternGridRef}
                                    onMouseMove={handlePatternMove}
                                    onMouseUp={handlePatternEnd}
                                    onMouseLeave={handlePatternEnd}
                                    onTouchMove={handlePatternMove}
                                    onTouchEnd={handlePatternEnd}
                                >
                                    <div className="pattern-grid">
                                        <svg className="pattern-svg">
                                            <path
                                                className={`pattern-line ${passwordSuccess ? 'success' : ''}`}
                                                d={getPatternPath(patternInput, isDrawingPattern ? currentPoint : null)}
                                            />
                                        </svg>
                                        {[0, 1, 2, 3, 4, 5, 6, 7, 8].map(idx => (
                                            <div
                                                key={idx}
                                                ref={el => dotRefs.current[idx] = el}
                                                className={`pattern-dot ${patternInput.includes(idx) ? 'selected' : ''} ${passwordSuccess ? 'success' : ''}`}
                                                onMouseDown={(e) => handlePatternStart(idx, e)}
                                                onTouchStart={(e) => handlePatternStart(idx, e)}
                                            />
                                        ))}
                                    </div>
                                    <div className="pattern-hint">
                                        {patternInput.length > 0 ? (
                                            <span className="pattern-dots-count">{patternInput.length} dots selected</span>
                                        ) : (
                                            'Touch a dot to start'
                                        )}
                                    </div>
                                </div>

                                <div className="flex gap-3 mt-4">
                                    <button
                                        onClick={clearPatternInput}
                                        className="flex-1 py-3 bg-gray-200 text-gray-700 rounded-xl font-semibold hover:bg-gray-300"
                                    >
                                        Clear
                                    </button>
                                    <button
                                        onClick={() => { setShowPasswordSetup(false); setPendingPasswordAction(null); clearPatternInput(); }}
                                        className="flex-1 py-3 bg-red-100 text-red-600 rounded-xl font-semibold hover:bg-red-200"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Password Entry Modal */}
                    {showPasswordEntry && (
                        <div className="modal-overlay" onClick={() => { setShowPasswordEntry(false); setPendingPasswordAction(null); clearPatternInput(); }}>
                            <div className="modal-content" onClick={e => e.stopPropagation()}>
                                <h2 className="text-2xl font-bold text-purple-600 text-center mb-2">üîê Enter Parent Pattern</h2>
                                <p className="text-gray-600 text-center mb-4">
                                    Draw your secret pattern to continue
                                </p>

                                {passwordError && (
                                    <div className="bg-red-100 text-red-600 p-3 rounded-xl text-center mb-4 font-semibold">
                                        ‚ùå Wrong pattern! Try again.
                                    </div>
                                )}

                                <div
                                    className="pattern-lock-container"
                                    ref={patternGridRef}
                                    onMouseMove={handlePatternMove}
                                    onMouseUp={handlePatternEnd}
                                    onMouseLeave={handlePatternEnd}
                                    onTouchMove={handlePatternMove}
                                    onTouchEnd={handlePatternEnd}
                                >
                                    <div className="pattern-grid">
                                        <svg className="pattern-svg">
                                            <path
                                                className={`pattern-line ${passwordError ? 'error' : ''} ${passwordSuccess ? 'success' : ''}`}
                                                d={getPatternPath(patternInput, isDrawingPattern ? currentPoint : null)}
                                            />
                                        </svg>
                                        {[0, 1, 2, 3, 4, 5, 6, 7, 8].map(idx => (
                                            <div
                                                key={idx}
                                                ref={el => dotRefs.current[idx] = el}
                                                className={`pattern-dot ${patternInput.includes(idx) ? 'selected' : ''} ${passwordError ? 'error' : ''} ${passwordSuccess ? 'success' : ''}`}
                                                onMouseDown={(e) => handlePatternStart(idx, e)}
                                                onTouchStart={(e) => handlePatternStart(idx, e)}
                                            />
                                        ))}
                                    </div>
                                    <div className="pattern-hint">
                                        {patternInput.length > 0 ? (
                                            <span className="pattern-dots-count">{patternInput.length} dots</span>
                                        ) : (
                                            'Touch a dot to start'
                                        )}
                                    </div>
                                </div>

                                <div className="flex gap-3 mt-4">
                                    <button
                                        onClick={clearPatternInput}
                                        className="flex-1 py-3 bg-gray-200 text-gray-700 rounded-xl font-semibold hover:bg-gray-300"
                                    >
                                        Clear
                                    </button>
                                    <button
                                        onClick={() => { setShowPasswordEntry(false); setPendingPasswordAction(null); clearPatternInput(); }}
                                        className="flex-1 py-3 bg-red-100 text-red-600 rounded-xl font-semibold hover:bg-red-200"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Chore Management Modal */}
                    {showChoreManagement && (
                        <div className="modal-overlay" onClick={() => setShowChoreManagement(false)}>
                            <div className="modal-content" style={{maxWidth: '600px'}} onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold text-purple-600">‚öôÔ∏è Manage Chores</h2>
                                    <button
                                        onClick={() => setShowChoreManagement(false)}
                                        className="text-gray-400 hover:text-gray-600 text-2xl"
                                    >‚úï</button>
                                </div>

                                <div className="management-tabs">
                                    <button
                                        className={`management-tab ${choreManagementTab === 'active' ? 'active' : ''}`}
                                        onClick={() => setChoreManagementTab('active')}
                                    >
                                        üìã Active ({tasks.length})
                                    </button>
                                    <button
                                        className={`management-tab ${choreManagementTab === 'saved' ? 'active' : ''}`}
                                        onClick={() => setChoreManagementTab('saved')}
                                    >
                                        üíæ Saved ({savedChores.length})
                                    </button>
                                </div>

                                {choreManagementTab === 'active' && (
                                    <>
                                        <button
                                            onClick={() => openChoreEditor()}
                                            className="w-full py-3 mb-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-bold hover:scale-102 transition-all"
                                        >
                                            ‚ûï Add New Chore
                                        </button>

                                        <div className="space-y-3 max-h-64 overflow-y-auto">
                                            {tasks.map(chore => (
                                                <div key={chore.id} className="chore-card">
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex items-center gap-3">
                                                            <span className="text-3xl">{chore.icon}</span>
                                                            <div>
                                                                <div className="font-bold text-gray-800">{chore.name}</div>
                                                                <div className="text-sm text-purple-600">üíé {chore.points} gems</div>
                                                            </div>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button
                                                                onClick={() => openChoreEditor(chore)}
                                                                className="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200"
                                                                title="Edit"
                                                            >‚úèÔ∏è</button>
                                                            <button
                                                                onClick={() => saveChoreForLater(chore.id)}
                                                                className="p-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200"
                                                                title="Save for later"
                                                            >üíæ</button>
                                                            <button
                                                                onClick={() => deleteChore(chore.id)}
                                                                className="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200"
                                                                title="Delete"
                                                            >üóëÔ∏è</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </>
                                )}

                                {choreManagementTab === 'saved' && (
                                    <div className="space-y-3 max-h-80 overflow-y-auto">
                                        {savedChores.length === 0 ? (
                                            <div className="text-center text-gray-500 py-8">
                                                No saved chores. Use the üíæ button to save chores for later!
                                            </div>
                                        ) : savedChores.map(chore => (
                                            <div key={chore.id} className="chore-card saved-later">
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center gap-3">
                                                        <span className="text-3xl">{chore.icon}</span>
                                                        <div>
                                                            <div className="font-bold text-gray-800">{chore.name}</div>
                                                            <div className="text-sm text-purple-600">üíé {chore.points} gems</div>
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={() => restoreChore(chore.id)}
                                                            className="p-2 bg-green-100 text-green-600 rounded-lg hover:bg-green-200"
                                                            title="Restore to active"
                                                        >‚ûï</button>
                                                        <button
                                                            onClick={() => setSavedChores(prev => prev.filter(c => c.id !== chore.id))}
                                                            className="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200"
                                                            title="Delete"
                                                        >üóëÔ∏è</button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                <div className="mt-6 pt-4 border-t">
                                    <button
                                        onClick={() => {
                                            setParentPassword(null);
                                            setShowChoreManagement(false);
                                        }}
                                        className="w-full py-2 bg-gray-100 text-gray-600 rounded-xl font-semibold hover:bg-gray-200"
                                    >
                                        üîÑ Reset Parent Pattern
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Chore Editor Modal */}
                    {showChoreEditor && (
                        <div className="modal-overlay" onClick={() => setShowChoreEditor(false)}>
                            <div className="modal-content" onClick={e => e.stopPropagation()}>
                                <h2 className="text-2xl font-bold text-purple-600 text-center mb-6">
                                    {editingChore ? '‚úèÔ∏è Edit Chore' : '‚ûï New Chore'}
                                </h2>

                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">Chore Name</label>
                                        <input
                                            type="text"
                                            className="input-field"
                                            placeholder="e.g., Clean your room"
                                            value={choreForm.name}
                                            onChange={e => setChoreForm(prev => ({ ...prev, name: e.target.value }))}
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">Icon</label>
                                        <div className="flex flex-wrap gap-2">
                                            {CHORE_ICONS.map(icon => (
                                                <button
                                                    key={icon}
                                                    onClick={() => setChoreForm(prev => ({ ...prev, icon }))}
                                                    className={`text-2xl p-2 rounded-lg transition-all ${
                                                        choreForm.icon === icon
                                                            ? 'bg-purple-500 scale-110'
                                                            : 'bg-gray-100 hover:bg-gray-200'
                                                    }`}
                                                >
                                                    {icon}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">Gem Reward</label>
                                        <div className="flex items-center gap-3">
                                            <input
                                                type="number"
                                                min="1"
                                                max="100"
                                                className="input-field gem-input"
                                                value={choreForm.points}
                                                onChange={e => setChoreForm(prev => ({ ...prev, points: parseInt(e.target.value) || 1 }))}
                                            />
                                            <span className="text-2xl">üíé</span>
                                        </div>
                                    </div>

                                    <div className="space-y-2">
                                        <label className="toggle-label block mb-2">Repeat Options</label>
                                        <div className="flex flex-col gap-2">
                                            <button
                                                onClick={() => setChoreForm(prev => ({ ...prev, repeatType: 'once' }))}
                                                className={`p-3 rounded-xl text-left transition-all ${
                                                    choreForm.repeatType === 'once'
                                                        ? 'bg-purple-500 text-white'
                                                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                                }`}
                                            >
                                                <span className="font-semibold">üî≤ One-time only</span>
                                                <span className="block text-sm opacity-80">Complete once, then remove</span>
                                            </button>
                                            <button
                                                onClick={() => setChoreForm(prev => ({ ...prev, repeatType: 'daily' }))}
                                                className={`p-3 rounded-xl text-left transition-all ${
                                                    choreForm.repeatType === 'daily'
                                                        ? 'bg-purple-500 text-white'
                                                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                                }`}
                                            >
                                                <span className="font-semibold">üîÑ Repeat daily</span>
                                                <span className="block text-sm opacity-80">Resets each day</span>
                                            </button>
                                            <button
                                                onClick={() => setChoreForm(prev => ({ ...prev, repeatType: 'multiple' }))}
                                                className={`p-3 rounded-xl text-left transition-all ${
                                                    choreForm.repeatType === 'multiple'
                                                        ? 'bg-purple-500 text-white'
                                                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                                }`}
                                            >
                                                <span className="font-semibold">üîÅ Multiple per day</span>
                                                <span className="block text-sm opacity-80">Can complete multiple times daily</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex gap-3 mt-6">
                                    <button
                                        onClick={() => setShowChoreEditor(false)}
                                        className="flex-1 py-3 bg-gray-200 text-gray-700 rounded-xl font-semibold hover:bg-gray-300"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={editingChore ? updateChore : addNewChore}
                                        disabled={!choreForm.name.trim()}
                                        className="flex-1 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-semibold hover:scale-102 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        {editingChore ? 'Save Changes' : 'Add Chore'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Parent Review Modal */}
                    {showParentReview && (
                        <div className="modal-overlay" onClick={() => setShowParentReview(false)}>
                            <div className="modal-content" style={{maxWidth: '600px'}} onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold text-purple-600">üë®‚Äçüë©‚Äçüëß Review Chores</h2>
                                    <button
                                        onClick={() => setShowParentReview(false)}
                                        className="text-gray-400 hover:text-gray-600 text-2xl"
                                    >‚úï</button>
                                </div>

                                <p className="text-gray-600 mb-4">
                                    Review each completed chore. Approved chores award gems!
                                </p>

                                <div className="space-y-4 max-h-96 overflow-y-auto">
                                    {pendingApproval.map(chore => {
                                        const key = chore.approvalId || chore.id;
                                        return (
                                            <div key={key} className="parent-review-card">
                                                <div className="flex items-center gap-4 mb-3">
                                                    <span className="text-4xl">{chore.icon}</span>
                                                    <div className="flex-1">
                                                        <div className="font-bold text-lg text-gray-800">
                                                            {chore.name}
                                                            {chore.repeatType === 'multiple' && (
                                                                <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full ml-2">üîÅ</span>
                                                            )}
                                                        </div>
                                                        <div className="flex items-center gap-2 text-purple-600">
                                                            <span>üíé {chore.totalPoints} gems</span>
                                                            {chore.streakBonus > 0 && (
                                                                <span className="text-orange-500">(+{chore.streakBonus} streak bonus)</span>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>

                                                <div className="review-actions">
                                                    <button
                                                        onClick={() => setReviewDecision(key, 'pass')}
                                                        className={`review-btn pass ${reviewDecisions[key] === 'pass' ? 'ring-4 ring-green-300' : ''}`}
                                                    >
                                                        ‚úÖ Approve
                                                    </button>
                                                    <button
                                                        onClick={() => setReviewDecision(key, 'fail')}
                                                        className={`review-btn fail ${reviewDecisions[key] === 'fail' ? 'ring-4 ring-red-300' : ''}`}
                                                    >
                                                        ‚ùå Redo
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>

                                <div className="mt-6 pt-4 border-t">
                                    <button
                                        onClick={submitReviews}
                                        disabled={Object.keys(reviewDecisions).length !== pendingApproval.length}
                                        className="w-full py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-bold text-lg hover:scale-102 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                                    >
                                        Submit Reviews ({Object.keys(reviewDecisions).length}/{pendingApproval.length})
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        ReactDOM.render(<ChoreQuestApp />, document.getElementById('root'));
    </script>
</body>
</html>
